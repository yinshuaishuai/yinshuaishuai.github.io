<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 5.4.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/ys_ico.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/ys_ico.ico">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha256-yIDrPSXHZdOZhAqiBP7CKzIwMQmRCJ8UeB8Jo17YC4o=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.28/fancybox/fancybox.css" integrity="sha256-6cQIC71/iBIYXFK+0RHAvwmjwWzkWd+r7v/BX3/vZDc=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"ysymj.gitee.io","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.19.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="哔哩哔哩视频《尚硅谷SpringBoot3响应式编程教程，2024最新springboot入门到实战》学习笔记，地址：https:&#x2F;&#x2F;www.bilibili.com&#x2F;video&#x2F;BV1sC4y1K7ET">
<meta property="og:type" content="article">
<meta property="og:title" content="尚硅谷springboot3响应式编程">
<meta property="og:url" content="http://ysymj.gitee.io/2024/01/14/spring/%E5%B0%9A%E7%A1%85%E8%B0%B7springboot3%E5%93%8D%E5%BA%94%E5%BC%8F%E7%BC%96%E7%A8%8B/index.html">
<meta property="og:site_name" content="YS">
<meta property="og:description" content="哔哩哔哩视频《尚硅谷SpringBoot3响应式编程教程，2024最新springboot入门到实战》学习笔记，地址：https:&#x2F;&#x2F;www.bilibili.com&#x2F;video&#x2F;BV1sC4y1K7ET">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://ysymj.gitee.io/2024/01/14/spring/%E5%B0%9A%E7%A1%85%E8%B0%B7springboot3%E5%93%8D%E5%BA%94%E5%BC%8F%E7%BC%96%E7%A8%8B/Stream%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B%E5%9B%BE%E7%A4%BA.png">
<meta property="og:image" content="http://ysymj.gitee.io/2024/01/14/spring/%E5%B0%9A%E7%A1%85%E8%B0%B7springboot3%E5%93%8D%E5%BA%94%E5%BC%8F%E7%BC%96%E7%A8%8B/%E5%93%8D%E5%BA%94%E5%BC%8F%E5%9B%BE%E7%A4%BA.png">
<meta property="og:image" content="http://ysymj.gitee.io/2024/01/14/spring/%E5%B0%9A%E7%A1%85%E8%B0%B7springboot3%E5%93%8D%E5%BA%94%E5%BC%8F%E7%BC%96%E7%A8%8B/Reactive%E8%A7%A3%E5%86%B3%E7%9A%84%E9%97%AE%E9%A2%98%E5%9B%BE%E7%A4%BA.png">
<meta property="og:image" content="http://ysymj.gitee.io/2024/01/14/spring/%E5%B0%9A%E7%A1%85%E8%B0%B7springboot3%E5%93%8D%E5%BA%94%E5%BC%8F%E7%BC%96%E7%A8%8B/%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B%E5%9B%BE%E7%A4%BA.png">
<meta property="og:image" content="http://ysymj.gitee.io/2024/01/14/spring/%E5%B0%9A%E7%A1%85%E8%B0%B7springboot3%E5%93%8D%E5%BA%94%E5%BC%8F%E7%BC%96%E7%A8%8B/%E5%93%8D%E5%BA%94%E5%BC%8F%E7%BC%96%E7%A8%8B%E6%A8%A1%E5%9E%8B%E5%9B%BE%E7%A4%BA.png">
<meta property="og:image" content="http://ysymj.gitee.io/2024/01/14/spring/%E5%B0%9A%E7%A1%85%E8%B0%B7springboot3%E5%93%8D%E5%BA%94%E5%BC%8F%E7%BC%96%E7%A8%8B/SpringMVC-SpringWebFlux%E5%AF%B9%E6%AF%94%E5%9B%BE%E7%A4%BA.png">
<meta property="og:image" content="http://ysymj.gitee.io/2024/01/14/spring/%E5%B0%9A%E7%A1%85%E8%B0%B7springboot3%E5%93%8D%E5%BA%94%E5%BC%8F%E7%BC%96%E7%A8%8B/SpringSecurity%E9%BB%98%E8%AE%A4%E7%99%BB%E5%BD%95%E9%A1%B5%E9%9D%A2%E5%9B%BE%E7%A4%BA.png">
<meta property="article:published_time" content="2024-01-14T03:02:12.000Z">
<meta property="article:modified_time" content="2024-03-02T11:37:47.822Z">
<meta property="article:author" content="YS">
<meta property="article:tag" content="springboot3">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://ysymj.gitee.io/2024/01/14/spring/%E5%B0%9A%E7%A1%85%E8%B0%B7springboot3%E5%93%8D%E5%BA%94%E5%BC%8F%E7%BC%96%E7%A8%8B/Stream%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B%E5%9B%BE%E7%A4%BA.png">


<link rel="canonical" href="http://ysymj.gitee.io/2024/01/14/spring/%E5%B0%9A%E7%A1%85%E8%B0%B7springboot3%E5%93%8D%E5%BA%94%E5%BC%8F%E7%BC%96%E7%A8%8B/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://ysymj.gitee.io/2024/01/14/spring/%E5%B0%9A%E7%A1%85%E8%B0%B7springboot3%E5%93%8D%E5%BA%94%E5%BC%8F%E7%BC%96%E7%A8%8B/","path":"2024/01/14/spring/尚硅谷springboot3响应式编程/","title":"尚硅谷springboot3响应式编程"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>尚硅谷springboot3响应式编程 | YS</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">YS</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">学无止境</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Reactor%E6%A0%B8%E5%BF%83"><span class="nav-number">1.</span> <span class="nav-text">Reactor核心</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86"><span class="nav-number">1.1.</span> <span class="nav-text">前置知识</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Lambda"><span class="nav-number">1.1.1.</span> <span class="nav-text">Lambda</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%87%BD%E6%95%B0%E5%BC%8F%E6%8E%A5%E5%8F%A3"><span class="nav-number">1.1.2.</span> <span class="nav-text">函数式接口</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Consumer"><span class="nav-number">1.1.2.1.</span> <span class="nav-text">Consumer</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Function"><span class="nav-number">1.1.2.2.</span> <span class="nav-text">Function</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Runnable"><span class="nav-number">1.1.2.3.</span> <span class="nav-text">Runnable</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Supplier"><span class="nav-number">1.1.2.4.</span> <span class="nav-text">Supplier</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Predicate"><span class="nav-number">1.1.2.5.</span> <span class="nav-text">Predicate</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#BiXxxxx"><span class="nav-number">1.1.2.6.</span> <span class="nav-text">BiXxxxx</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#NnnXxxx"><span class="nav-number">1.1.2.7.</span> <span class="nav-text">NnnXxxx</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#StreamAPI"><span class="nav-number">1.1.3.</span> <span class="nav-text">StreamAPI</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%AD%E9%97%B4%E6%93%8D%E4%BD%9C%EF%BC%9AIntermediate-Operations"><span class="nav-number">1.1.3.1.</span> <span class="nav-text">中间操作：Intermediate Operations</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BB%88%E6%AD%A2%E6%93%8D%E4%BD%9C%EF%BC%9ATerminal-Operation"><span class="nav-number">1.1.3.2.</span> <span class="nav-text">终止操作：Terminal Operation</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E6%B5%81"><span class="nav-number">1.1.3.3.</span> <span class="nav-text">创建流</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B5%81%E4%B8%8E%E9%9B%86%E5%90%88"><span class="nav-number">1.1.3.4.</span> <span class="nav-text">流与集合</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Reactive-Stream"><span class="nav-number">1.1.4.</span> <span class="nav-text">Reactive-Stream</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Reactive-Stream%E7%BB%84%E4%BB%B6"><span class="nav-number">1.1.4.1.</span> <span class="nav-text">Reactive-Stream组件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%93%8D%E5%BA%94%E5%BC%8F%E7%BC%96%E7%A8%8B"><span class="nav-number">1.1.4.2.</span> <span class="nav-text">响应式编程</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Reactor"><span class="nav-number">1.2.</span> <span class="nav-text">Reactor</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B"><span class="nav-number">1.2.1.</span> <span class="nav-text">快速上手</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%8B%E7%BB%8D"><span class="nav-number">1.2.1.1.</span> <span class="nav-text">介绍</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BE%9D%E8%B5%96"><span class="nav-number">1.2.1.2.</span> <span class="nav-text">依赖</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%93%8D%E5%BA%94%E5%BC%8F%E7%BC%96%E7%A8%8B-1"><span class="nav-number">1.2.2.</span> <span class="nav-text">响应式编程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%98%BB%E5%A1%9E%E6%98%AF%E5%AF%B9%E8%B5%84%E6%BA%90%E7%9A%84%E6%B5%AA%E8%B4%B9"><span class="nav-number">1.2.2.1.</span> <span class="nav-text">阻塞是对资源的浪费</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BC%82%E6%AD%A5%E5%8F%AF%E4%BB%A5%E8%A7%A3%E5%86%B3%E9%97%AE%E9%A2%98%E5%90%97%EF%BC%9F"><span class="nav-number">1.2.2.2.</span> <span class="nav-text">异步可以解决问题吗？</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%8E%E5%91%BD%E4%BB%A4%E5%BC%8F%E7%BC%96%E7%A8%8B%E5%88%B0%E5%93%8D%E5%BA%94%E5%BC%8F%E7%BC%96%E7%A8%8B"><span class="nav-number">1.2.2.3.</span> <span class="nav-text">从命令式编程到响应式编程</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%8F%AF%E7%BC%96%E6%8E%92%E6%80%A7%E4%B8%8E%E5%8F%AF%E8%AF%BB%E6%80%A7"><span class="nav-number">1.2.2.3.1.</span> <span class="nav-text">可编排性与可读性</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%B0%B1%E5%83%8F%E8%A3%85%E9%85%8D%E6%B5%81%E6%B0%B4%E7%BA%BF"><span class="nav-number">1.2.2.3.2.</span> <span class="nav-text">就像装配流水线</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%93%8D%E4%BD%9C%E7%AC%A6%EF%BC%88Operators%EF%BC%89"><span class="nav-number">1.2.2.3.3.</span> <span class="nav-text">操作符（Operators）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#subscribe-%E4%B9%8B%E5%89%8D%E4%BB%80%E4%B9%88%E9%83%BD%E4%B8%8D%E4%BC%9A%E5%8F%91%E7%94%9F"><span class="nav-number">1.2.2.3.4.</span> <span class="nav-text">subscribe() 之前什么都不会发生</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%83%8C%E5%8E%8B"><span class="nav-number">1.2.2.3.5.</span> <span class="nav-text">背压</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%83%AD%EF%BC%88Hot%EF%BC%89-vs-%E5%86%B7%EF%BC%88Cold%EF%BC%89"><span class="nav-number">1.2.2.3.6.</span> <span class="nav-text">热（Hot） vs 冷（Cold）</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83%E7%89%B9%E6%80%A7"><span class="nav-number">1.2.3.</span> <span class="nav-text">核心特性</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Mono%E5%92%8CFlux"><span class="nav-number">1.2.3.1.</span> <span class="nav-text">Mono和Flux</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#subscribe"><span class="nav-number">1.2.3.2.</span> <span class="nav-text">subscribe()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B5%81%E7%9A%84%E5%8F%96%E6%B6%88"><span class="nav-number">1.2.3.3.</span> <span class="nav-text">流的取消</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#BaseSubscriber"><span class="nav-number">1.2.3.4.</span> <span class="nav-text">BaseSubscriber</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%83%8C%E5%8E%8B%EF%BC%88Backpressure-%EF%BC%89%E5%92%8C%E8%AF%B7%E6%B1%82%E9%87%8D%E5%A1%91%EF%BC%88Reshape-Requests%EF%BC%89"><span class="nav-number">1.2.3.5.</span> <span class="nav-text">背压（Backpressure ）和请求重塑（Reshape Requests）</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#buffer%EF%BC%9A%E7%BC%93%E5%86%B2"><span class="nav-number">1.2.3.5.1.</span> <span class="nav-text">buffer：缓冲</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#limit%EF%BC%9A%E9%99%90%E6%B5%81"><span class="nav-number">1.2.3.5.2.</span> <span class="nav-text">limit：限流</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%A5%E7%BC%96%E7%A8%8B%E6%96%B9%E5%BC%8F%E5%88%9B%E5%BB%BA%E5%BA%8F%E5%88%97-Sink"><span class="nav-number">1.2.3.6.</span> <span class="nav-text">以编程方式创建序列-Sink</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%90%8C%E6%AD%A5%E7%8E%AF%E5%A2%83-generate"><span class="nav-number">1.2.3.6.1.</span> <span class="nav-text">同步环境-generate</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%A4%9A%E7%BA%BF%E7%A8%8B-create"><span class="nav-number">1.2.3.6.2.</span> <span class="nav-text">多线程-create</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#handle"><span class="nav-number">1.2.3.7.</span> <span class="nav-text">handle()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BA%BF%E7%A8%8B%E8%B0%83%E5%BA%A6"><span class="nav-number">1.2.3.8.</span> <span class="nav-text">自定义线程调度</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86"><span class="nav-number">1.2.3.9.</span> <span class="nav-text">错误处理</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Catch-and-return-a-static-default-value-%E6%8D%95%E8%8E%B7%E5%BC%82%E5%B8%B8%E8%BF%94%E5%9B%9E%E4%B8%80%E4%B8%AA%E9%9D%99%E6%80%81%E9%BB%98%E8%AE%A4%E5%80%BC"><span class="nav-number">1.2.3.9.1.</span> <span class="nav-text">Catch and return a static default value. 捕获异常返回一个静态默认值</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Catch-and-execute-an-alternative-path-with-a-fallback-method-%E5%90%83%E6%8E%89%E5%BC%82%E5%B8%B8%EF%BC%8C%E6%89%A7%E8%A1%8C%E4%B8%80%E4%B8%AA%E5%85%9C%E5%BA%95%E6%96%B9%E6%B3%95%EF%BC%9B"><span class="nav-number">1.2.3.9.2.</span> <span class="nav-text">Catch and execute an alternative path with a fallback method.  吃掉异常，执行一个兜底方法；</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Catch-and-dynamically-compute-a-fallback-value-%E6%8D%95%E8%8E%B7%E5%B9%B6%E5%8A%A8%E6%80%81%E8%AE%A1%E7%AE%97%E4%B8%80%E4%B8%AA%E8%BF%94%E5%9B%9E%E5%80%BC"><span class="nav-number">1.2.3.9.3.</span> <span class="nav-text">Catch and dynamically compute a fallback value. 捕获并动态计算一个返回值</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Catch-wrap-to-a-BusinessException-and-re-throw-%E6%8D%95%E8%8E%B7%E5%B9%B6%E5%8C%85%E8%A3%85%E6%88%90%E4%B8%80%E4%B8%AA%E4%B8%9A%E5%8A%A1%E5%BC%82%E5%B8%B8%EF%BC%8C%E5%B9%B6%E9%87%8D%E6%96%B0%E6%8A%9B%E5%87%BA"><span class="nav-number">1.2.3.9.4.</span> <span class="nav-text">Catch, wrap to a BusinessException, and re-throw.  捕获并包装成一个业务异常，并重新抛出</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Catch-log-an-error-specific-message-and-re-throw-%E6%8D%95%E8%8E%B7%E5%BC%82%E5%B8%B8%EF%BC%8C%E8%AE%B0%E5%BD%95%E7%89%B9%E6%AE%8A%E7%9A%84%E9%94%99%E8%AF%AF%E6%97%A5%E5%BF%97%EF%BC%8C%E9%87%8D%E6%96%B0%E6%8A%9B%E5%87%BA"><span class="nav-number">1.2.3.9.5.</span> <span class="nav-text">Catch, log an error-specific message, and re-throw.  捕获异常，记录特殊的错误日志，重新抛出</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Use-the-finally-block-to-clean-up-resources-or-a-Java-7-%E2%80%9Ctry-with-resource%E2%80%9D-construct"><span class="nav-number">1.2.3.9.6.</span> <span class="nav-text">Use the finally block to clean up resources or a Java 7 “try-with-resource” construct.</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%BF%BD%E7%95%A5%E5%BD%93%E5%89%8D%E5%BC%82%E5%B8%B8%EF%BC%8C%E4%BB%85%E9%80%9A%E7%9F%A5%E8%AE%B0%E5%BD%95%EF%BC%8C%E7%BB%A7%E7%BB%AD%E6%8E%A8%E8%BF%9B"><span class="nav-number">1.2.3.9.7.</span> <span class="nav-text">忽略当前异常，仅通知记录，继续推进</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B8%B8%E7%94%A8%E6%93%8D%E4%BD%9C"><span class="nav-number">1.2.3.10.</span> <span class="nav-text">常用操作</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Spring-Webflux"><span class="nav-number">2.</span> <span class="nav-text">Spring Webflux</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BB%84%E4%BB%B6%E5%AF%B9%E6%AF%94"><span class="nav-number">2.1.</span> <span class="nav-text">组件对比</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#WebFlux"><span class="nav-number">2.2.</span> <span class="nav-text">WebFlux</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%95%E5%85%A5"><span class="nav-number">2.2.1.</span> <span class="nav-text">引入</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Reactor-Core"><span class="nav-number">2.2.2.</span> <span class="nav-text">Reactor Core</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#HttpHandler%E3%80%81HttpServer"><span class="nav-number">2.2.2.1.</span> <span class="nav-text">HttpHandler、HttpServer</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DispatcherHandler"><span class="nav-number">2.2.3.</span> <span class="nav-text">DispatcherHandler</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B"><span class="nav-number">2.2.3.1.</span> <span class="nav-text">请求处理流程</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B3%A8%E8%A7%A3%E5%BC%80%E5%8F%91"><span class="nav-number">2.2.4.</span> <span class="nav-text">注解开发</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%9B%AE%E6%A0%87%E6%96%B9%E6%B3%95%E4%BC%A0%E5%8F%82"><span class="nav-number">2.2.4.1.</span> <span class="nav-text">目标方法传参</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BF%94%E5%9B%9E%E5%80%BC%E5%86%99%E6%B3%95"><span class="nav-number">2.2.4.2.</span> <span class="nav-text">返回值写法</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0"><span class="nav-number">2.2.5.</span> <span class="nav-text">文件上传</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86-1"><span class="nav-number">2.2.6.</span> <span class="nav-text">错误处理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RequestContext"><span class="nav-number">2.2.7.</span> <span class="nav-text">RequestContext</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89Flux%E9%85%8D%E7%BD%AE"><span class="nav-number">2.2.8.</span> <span class="nav-text">自定义Flux配置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#WebFluxConfigurer"><span class="nav-number">2.2.8.1.</span> <span class="nav-text">WebFluxConfigurer</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Filter"><span class="nav-number">2.2.9.</span> <span class="nav-text">Filter</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#R2DBC"><span class="nav-number">3.</span> <span class="nav-text">R2DBC</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#R2dbc"><span class="nav-number">3.1.</span> <span class="nav-text">R2dbc</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Spring-Data-R2DBC"><span class="nav-number">3.2.</span> <span class="nav-text">Spring Data R2DBC</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B4%E5%90%88"><span class="nav-number">3.2.1.</span> <span class="nav-text">整合</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A3%B0%E6%98%8E%E5%BC%8F%E6%8E%A5%E5%8F%A3%EF%BC%9AR2dbcRepository"><span class="nav-number">3.2.2.</span> <span class="nav-text">声明式接口：R2dbcRepository</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Repository%E6%8E%A5%E5%8F%A3"><span class="nav-number">3.2.2.1.</span> <span class="nav-text">Repository接口</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89Converter"><span class="nav-number">3.2.2.2.</span> <span class="nav-text">自定义Converter</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E7%94%9F%E6%95%88"><span class="nav-number">3.2.2.3.</span> <span class="nav-text">配置生效</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%96%E7%A8%8B%E5%BC%8F%E7%BB%84%E4%BB%B6"><span class="nav-number">3.2.3.</span> <span class="nav-text">编程式组件</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RBAC-SQL%E7%BB%83%E4%B9%A0"><span class="nav-number">3.3.</span> <span class="nav-text">RBAC-SQL练习</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1"><span class="nav-number">3.3.1.</span> <span class="nav-text">1-1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-N"><span class="nav-number">3.3.2.</span> <span class="nav-text">1-N</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="nav-number">3.4.</span> <span class="nav-text">最佳实践</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%99%84%E5%BD%95"><span class="nav-number">3.5.</span> <span class="nav-text">附录</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Spring-Security-Reactive"><span class="nav-number">4.</span> <span class="nav-text">Spring Security Reactive</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%B4%E5%90%88-1"><span class="nav-number">4.1.</span> <span class="nav-text">整合</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BC%80%E5%8F%91"><span class="nav-number">4.2.</span> <span class="nav-text">开发</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BA%94%E7%94%A8%E5%AE%89%E5%85%A8"><span class="nav-number">4.2.1.</span> <span class="nav-text">应用安全</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RBAC%E6%9D%83%E9%99%90%E6%A8%A1%E5%9E%8B"><span class="nav-number">4.2.2.</span> <span class="nav-text">RBAC权限模型</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AE%A4%E8%AF%81"><span class="nav-number">4.3.</span> <span class="nav-text">认证</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90%E6%94%BE%E8%A1%8C"><span class="nav-number">4.3.1.</span> <span class="nav-text">静态资源放行</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B6%E4%BB%96%E8%AF%B7%E6%B1%82%E9%9C%80%E8%A6%81%E7%99%BB%E5%BD%95"><span class="nav-number">4.3.2.</span> <span class="nav-text">其他请求需要登录</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8E%88%E6%9D%83"><span class="nav-number">4.4.</span> <span class="nav-text">授权</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="YS"
      src="/images/author.png">
  <p class="site-author-name" itemprop="name">YS</p>
  <div class="site-description" itemprop="description">学海无涯苦作舟</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">63</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://ysymj.gitee.io/2024/01/14/spring/%E5%B0%9A%E7%A1%85%E8%B0%B7springboot3%E5%93%8D%E5%BA%94%E5%BC%8F%E7%BC%96%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/author.png">
      <meta itemprop="name" content="YS">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="YS">
      <meta itemprop="description" content="学海无涯苦作舟">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="尚硅谷springboot3响应式编程 | YS">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          尚硅谷springboot3响应式编程
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-01-14 11:02:12" itemprop="dateCreated datePublished" datetime="2024-01-14T11:02:12+08:00">2024-01-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-03-02 19:37:47" itemprop="dateModified" datetime="2024-03-02T19:37:47+08:00">2024-03-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/java%E6%A1%86%E6%9E%B6/" itemprop="url" rel="index"><span itemprop="name">java框架</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>52k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1:35</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1 id="Reactor核心"><a href="#Reactor核心" class="headerlink" title="Reactor核心"></a>Reactor核心</h1><h2 id="前置知识"><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h2><h3 id="Lambda"><a href="#Lambda" class="headerlink" title="Lambda"></a>Lambda</h3><p>Lambda表达式是Java8引入的一个重要特性；<br>Lambda表达式可以被视为匿名函数；<br>允许在需要函数的地方以更简洁的方式定义功能</p>
<p>java8语法糖：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.util.function.*;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Collectors;</span><br><span class="line"></span><br><span class="line"><span class="comment">//函数式接口；只要是函数式接口就可以用Lambda表达式简化</span></span><br><span class="line"><span class="comment">//函数式接口： 接口中有且只有一个未实现的方法，这个接口就叫函数式接口</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">MyInterface</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">sum</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> j)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">MyHaha</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">haha</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">default</span> <span class="keyword">int</span> <span class="title">heihei</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">    &#125; <span class="comment">//默认实现</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">My666</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">aaa</span><span class="params">(<span class="keyword">int</span> i,<span class="keyword">int</span> j,<span class="keyword">int</span> k)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@FunctionalInterface</span> <span class="comment">//检查注解，帮我们快速检查我们写的接口是否函数式接口</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">MyHehe</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">hehe</span><span class="params">(<span class="keyword">int</span> i)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//1、自己写实现类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyInterfaceImpl</span> <span class="keyword">implements</span> <span class="title">MyInterface</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">sum</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> j)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> i + j;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Lambda</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//声明一个函数</span></span><br><span class="line">        BiConsumer&lt;String,String&gt; consumer = (a,b)-&gt;&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;哈哈：&quot;</span>+a+<span class="string">&quot;；呵呵：&quot;</span>+b);</span><br><span class="line">        &#125;;</span><br><span class="line">        consumer.accept(<span class="string">&quot;1&quot;</span>,<span class="string">&quot;2&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//声明一个函数</span></span><br><span class="line">        Function&lt;String,Integer&gt; function = (String x) -&gt; Integer.parseInt(x);</span><br><span class="line">        System.out.println(function.apply(<span class="string">&quot;2&quot;</span>));</span><br><span class="line"></span><br><span class="line">        Supplier&lt;String&gt; supplier = ()-&gt; UUID.randomUUID().toString();</span><br><span class="line">        String s = supplier.get();</span><br><span class="line">        System.out.println(s);</span><br><span class="line"></span><br><span class="line">        BiFunction&lt;String,Integer,Long&gt; biFunction = (a,b)-&gt; <span class="number">888L</span>;</span><br><span class="line"></span><br><span class="line">        Predicate&lt;Integer&gt; even = (t)-&gt; t%<span class="number">2</span> ==<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//        even.test()//正向判断</span></span><br><span class="line"><span class="comment">//        even.negate().test(2) //反向判断</span></span><br><span class="line">        System.out.println(even.negate().test(<span class="number">2</span>));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">bbbbb</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> names = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line"></span><br><span class="line">        names.add(<span class="string">&quot;Alice&quot;</span>);</span><br><span class="line">        names.add(<span class="string">&quot;Bob&quot;</span>);</span><br><span class="line">        names.add(<span class="string">&quot;Charlie&quot;</span>);</span><br><span class="line">        names.add(<span class="string">&quot;David&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//比较器</span></span><br><span class="line"><span class="comment">//        Collections.sort(names, new Comparator&lt;String&gt;() &#123;</span></span><br><span class="line"><span class="comment">//            @Override</span></span><br><span class="line"><span class="comment">//            public int compare(String o1, String o2) &#123;</span></span><br><span class="line"><span class="comment">//                return o2.compareTo(o1);</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line"><span class="comment">//        &#125;);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//直接写函数式接口就方便   (o1,o2)-&gt;o1.compareTo(o2)</span></span><br><span class="line"><span class="comment">//        Collections.sort(names,(o1,o2)-&gt;o1.compareTo(o2));</span></span><br><span class="line">        System.out.println(names);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 类::方法； 引用类中的实例方法； 忽略lambda的完整写法</span></span><br><span class="line">        Collections.sort(names,String::compareTo);</span><br><span class="line">        System.out.println(names);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">new</span>  Thread(</span><br><span class="line">                <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        System.out.println(<span class="string">&quot;哈哈啊&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">        ).start();</span><br><span class="line"></span><br><span class="line">        Runnable runnable = () -&gt; System.out.println(<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(runnable).start();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//最佳实战：</span></span><br><span class="line">        <span class="comment">//1、以后调用某个方法传入参数，这个参数实例是一个接口对象，且只定义了一个方法，就直接用lambda简化写法</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * lambda简化函数式接口实例创建</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> args</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">aaaa</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//1、自己创建实现类对象</span></span><br><span class="line">        MyInterface myInterface = <span class="keyword">new</span> MyInterfaceImpl();</span><br><span class="line">        System.out.println(myInterface.sum(<span class="number">1</span>, <span class="number">2</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2、创建匿名实现类</span></span><br><span class="line">        MyInterface myInterface1 = <span class="keyword">new</span> MyInterface() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">sum</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> j)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> i * i + j * j;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"><span class="comment">//        System.out.println(myInterface1.sum(2, 3));</span></span><br><span class="line">        <span class="comment">//冗余写法</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//3、lambda表达式:语法糖  参数列表  + 箭头 + 方法体</span></span><br><span class="line">        MyInterface myInterface2 = (x, y) -&gt; &#123;</span><br><span class="line">            <span class="keyword">return</span> x * x + y * y;</span><br><span class="line">        &#125;;</span><br><span class="line">        System.out.println(myInterface2.sum(<span class="number">2</span>, <span class="number">3</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//参数位置最少情况</span></span><br><span class="line">        MyHaha myHaha = () -&gt; &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        MyHehe myHehe = y -&gt; &#123;</span><br><span class="line">            <span class="keyword">return</span> y * y;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        MyHehe hehe2 = y -&gt; y - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//完整写法如上：</span></span><br><span class="line">        <span class="comment">//简化写法：</span></span><br><span class="line">        <span class="comment">//1)、参数类型可以不写，只写(参数名)，参数变量名随意定义;</span></span><br><span class="line">        <span class="comment">//    参数表最少可以只有一个 ()，或者只有一个参数名；</span></span><br><span class="line">        <span class="comment">//2、方法体如果只有一句话，&#123;&#125; 可以省略</span></span><br><span class="line"></span><br><span class="line">        MyHehe hehe3 = y -&gt; y + <span class="number">1</span>;</span><br><span class="line">        System.out.println(hehe3.hehe(<span class="number">7</span>));</span><br><span class="line">        <span class="comment">//以上Lambda表达式简化了实例的创建。</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//总结：</span></span><br><span class="line">        <span class="comment">// 1、Lambda表达式： (参数表) -&gt; &#123;方法体&#125;</span></span><br><span class="line">        <span class="comment">// 2、分辨出你的接口是否函数式接口。 函数式接口就可以lambda简化</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="函数式接口"><a href="#函数式接口" class="headerlink" title="函数式接口"></a>函数式接口</h3><blockquote>
<p>在java中，函数式接口是只包含一个抽象方法的接口，他们是支持lambda表达式的基础，因为lamdba表达式需要一个<font color="#ff0000">目标类型</font>，这个目标类型必须是一个<font color="#ff0000">函数式接口</font>。</p>
</blockquote>
<p><code>java.util.function</code>包下的函数式接口一共分为三大类：</p>
<ul>
<li>Consumer：消费者</li>
<li>Supplier：提供者</li>
<li>Predicate：断言</li>
</ul>
<p>get/test/apply/accept调用的函数方法；</p>
<p><strong>jdk提供的函数式接口</strong></p>
<table>
<thead>
<tr>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td><font color="#c00000">Consumer</font><br>BiConsumer<br>IntConsumer<br>LongConsumer<br>DoubleConsumer<br>ObjDoubleConsumer<br>ObjIntConsumer<br>ObjLongConsumer</td>
<td><font color="#c00000">Function</font><br>BiFunction<br>IntFunction<br>LongFunction<br>DoubleFunction<br>IntToDoubleFunction<br>IntToLongFunction<br>DoubleToIntFunction<br>DoubleToLongFunction<br>LongToDoubleFunction<br>LongToIntFunction<br>ToDoubleBiFunction<br>ToDoubleFunction<br>ToIntBiFunction<br>ToIntFunction<br>ToLongBiFunction<br>ToLongFunction</td>
<td></td>
<td><font color="#c00000">Supplier</font><br>LongSupplier<br>BooleanSupplier<br>DoubleSupplier<br>IntSupplier</td>
<td><font color="#c00000">Predicate</font><br>BiPredicate<br>IntPredicate<br>LongPredicate<br>DoublePredicate</td>
<td>UnaryOperator<br>IntUnaryOperator<br>LongUnaryOperator<br>DoubleUnaryOperator<br><br>BinaryOperator<br>IntBinaryOperator<br>LongBinaryOperator<br>DoubleBinaryOperator</td>
</tr>
</tbody></table>
<h4 id="Consumer"><a href="#Consumer" class="headerlink" title="Consumer"></a>Consumer</h4><ul>
<li>有入参，无出参（消费者）：Consumer.accept</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Consumer&lt;String&gt; consumer = (String s) -&gt; &#123;  </span><br><span class="line">    System.out.println(s);  </span><br><span class="line">&#125;;  </span><br><span class="line">consumer.accept(<span class="string">&quot;hello&quot;</span>);</span><br></pre></td></tr></table></figure>

<h4 id="Function"><a href="#Function" class="headerlink" title="Function"></a>Function</h4><ul>
<li>有入参，有出参（多功能函数）：Function.apply</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Function&lt;String,Integer&gt; function = (String x) -&gt; Integer.parseInt(x);</span><br><span class="line">System.out.println(function.apply(<span class="string">&quot;2&quot;</span>));</span><br></pre></td></tr></table></figure>

<h4 id="Runnable"><a href="#Runnable" class="headerlink" title="Runnable"></a>Runnable</h4><ul>
<li>无入参，无出参（普通函数）：Runnable.run</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Runnable runnable = () -&gt; System.out.println(<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line"><span class="keyword">new</span> Thread(runnable).start();</span><br></pre></td></tr></table></figure>

<h4 id="Supplier"><a href="#Supplier" class="headerlink" title="Supplier"></a>Supplier</h4><ul>
<li>无入参，有出参（提供者）：Supplier.get</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Supplier&lt;String&gt; supplier = ()-&gt; UUID.randomUUID().toString();</span><br><span class="line">String s = supplier.get();</span><br><span class="line">System.out.println(s);</span><br></pre></td></tr></table></figure>

<h4 id="Predicate"><a href="#Predicate" class="headerlink" title="Predicate"></a>Predicate</h4><ul>
<li>断言，输入一个数据，返回布尔：Predicate.test<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Predicate&lt;Integer&gt; predicate = i -&gt; i%<span class="number">2</span>==<span class="number">0</span>;  </span><br><span class="line"><span class="keyword">if</span> (predicate.test(<span class="number">10</span>))&#123;  </span><br><span class="line">    System.out.println(<span class="string">&quot;偶数&quot;</span>);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="BiXxxxx"><a href="#BiXxxxx" class="headerlink" title="BiXxxxx"></a>BiXxxxx</h4><p>基于上面的几个函数进行扩展，可以有两个入参</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">BiConsumer&lt;String,String&gt; function = (a,b)-&gt;&#123; <span class="comment">//能接受两个入参</span></span><br><span class="line">    System.out.println(<span class="string">&quot;哈哈：&quot;</span>+a+<span class="string">&quot;；呵呵：&quot;</span>+b);</span><br><span class="line">        &#125;;</span><br><span class="line">function.accept(<span class="string">&quot;1&quot;</span>,<span class="string">&quot;2&quot;</span>);</span><br></pre></td></tr></table></figure>

<h4 id="NnnXxxx"><a href="#NnnXxxx" class="headerlink" title="NnnXxxx"></a>NnnXxxx</h4><p>入参由泛型固定为Nnn（某一种基本或者封装类型）类型，例如<code>DoubleConsumer</code>，将泛型固定为Double</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">DoubleConsumer doubleConsumer = (<span class="keyword">double</span> d) -&gt; &#123;  </span><br><span class="line">    System.out.println(d);  </span><br><span class="line">&#125;;  </span><br><span class="line">doubleConsumer.accept(<span class="number">23.1</span>);</span><br></pre></td></tr></table></figure>

<h3 id="StreamAPI"><a href="#StreamAPI" class="headerlink" title="StreamAPI"></a>StreamAPI</h3><p>声明式处理<font color="#ff0000">集合数据</font>，包括：筛选、转换、组合等。</p>
<ul>
<li>Stream Pipeline：流管道、流水线</li>
<li>Intermediate Operations：中间操作</li>
<li>Terminal Operation：终止操作</li>
</ul>
<p>Stream所有数据和操作被组合成流管道<br><font color="#ff0000">流管道组成</font>：</p>
<ul>
<li>一个数据源（可以是一个数组、集合、生成器函数、I/O管道）</li>
<li>零或多个中间操作（将一个流变形成另一个流）</li>
<li>一个终止操作（产生最终结果）</li>
</ul>
<p><font color="#9bbb59">流是惰性的</font>；只有在启动最终操作时才会对源数据进行计算，而且只在需要时才会消耗源元素</p>
<p><font color="#ff0000">一个流只能被操作一次</font></p>
<p><img src="/2024/01/14/spring/%E5%B0%9A%E7%A1%85%E8%B0%B7springboot3%E5%93%8D%E5%BA%94%E5%BC%8F%E7%BC%96%E7%A8%8B/Stream%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B%E5%9B%BE%E7%A4%BA.png" alt="Stream处理流程图示"></p>
<p>最佳实战：以后凡是写for循环处理数据的，统一全部用StreamAPI进行替换；<br>Stream所有数据和操作被组合成流管道组成：</p>
<ul>
<li>一个数据源（可以是一个数组、集合、生成器函数、I/O管道）</li>
<li>零或多个中间操作（将一个流变成另一个流）</li>
<li>一个终止操作（产生最终结果）</li>
</ul>
<h4 id="中间操作：Intermediate-Operations"><a href="#中间操作：Intermediate-Operations" class="headerlink" title="中间操作：Intermediate Operations"></a>中间操作：Intermediate Operations</h4><ul>
<li>filter：过滤；跳出我们需要的元素</li>
<li>map：映射；一一映射，a变成b<ul>
<li>mapToInt、mapToLong、mapToDouble</li>
</ul>
</li>
<li>flatMap：打散、散列、展开、扩维：一对多映射</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">filter、</span><br><span class="line">map、mapToInt、mapToLong、mapToDouble</span><br><span class="line">flatMap、flatMapToInt、flatMapToLong、flatMapToDouble</span><br><span class="line">mapMulti、mapMultiToInt、mapMultiToLong、mapMultiToDouble、</span><br><span class="line">parallel、unordered、onClose、sequential</span><br><span class="line">distinct、sorted、peek、limit、skip、takeWhile、dropWhile</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="center">方法</th>
<th align="center">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">filter</td>
<td align="center">过滤，挑出需要的元素，入参返回一个布尔类型，</td>
</tr>
<tr>
<td align="center">map</td>
<td align="center">映射，一一映射，a变成b，有一个入参必须有一个出参</td>
</tr>
<tr>
<td align="center">mapToInt</td>
<td align="center">映射，将其他类型映射成int，转为IntStream，可以进行一些int相关的操作</td>
</tr>
<tr>
<td align="center">mapToLong</td>
<td align="center">与上面类似，不过是转成LongStream</td>
</tr>
<tr>
<td align="center">mapToDouble</td>
<td align="center">与上面类型，转成DoubleStream</td>
</tr>
<tr>
<td align="center">flatMap</td>
<td align="center">打散、散列、展开、扩维：一对多映射（将一个元素扩展为一个流，然后再将所有的流收集合并）</td>
</tr>
<tr>
<td align="center">flatMapToInt</td>
<td align="center">作用与上一样，不过扩展出的流为IntStream</td>
</tr>
<tr>
<td align="center">flatMapToLong</td>
<td align="center">作用与上一样，不过扩展出的流为LongStream</td>
</tr>
<tr>
<td align="center">flatMapToDouble</td>
<td align="center">作用与上一样，不过扩展出的流为DoubleStream</td>
</tr>
<tr>
<td align="center">mapMulti</td>
<td align="center">内部调用flatMap进行处理，两个参数，第一个是元素，第二个是一个buffer，往buffer里面放什么，最后就会返回什么（总体功能和flatMap类似）</td>
</tr>
<tr>
<td align="center">mapMultiToInt</td>
<td align="center">限制buffer中的参数为int，并且内部调用的是flatMapToInt</td>
</tr>
<tr>
<td align="center">mapMultiToLong</td>
<td align="center">限制buffer中的参数为Long，并且内部调用的是flatMapToLong</td>
</tr>
<tr>
<td align="center">mapMultiToDouble</td>
<td align="center">限制buffer中的参数为Double，并且内部调用的是flatMapToDounble</td>
</tr>
<tr>
<td align="center">parallel</td>
<td align="center">开启并发流</td>
</tr>
<tr>
<td align="center">unordered</td>
<td align="center">消除顺序限制，不再保证顺序（并不会打乱流的顺序，而是不再保证顺序）</td>
</tr>
<tr>
<td align="center">onClose</td>
<td align="center">回调方法，当流的中间操作以及终结操作结束之后，会回调该方法</td>
</tr>
<tr>
<td align="center">sequential</td>
<td align="center">将并行流转为串行流，强制后续操作有序执行</td>
</tr>
<tr>
<td align="center">distinct</td>
<td align="center">去重</td>
</tr>
<tr>
<td align="center">sorted</td>
<td align="center">排序</td>
</tr>
<tr>
<td align="center">peek</td>
<td align="center">消费执行，不会改变流的类型</td>
</tr>
<tr>
<td align="center">limit</td>
<td align="center">分页，限制流中元素的数量，超出的将舍弃</td>
</tr>
<tr>
<td align="center">skip</td>
<td align="center">跳过，跳过流中前几个元素</td>
</tr>
<tr>
<td align="center">takeWhile</td>
<td align="center">满足条件时取出元素，当遇到第一个不满足条件的元素后，将忽略后面所有元素</td>
</tr>
<tr>
<td align="center">dropWhile</td>
<td align="center">忽略满足条件的元素，直到第一个不满足条件的元素出现，将不再忽略后面的元素</td>
</tr>
</tbody></table>
<h4 id="终止操作：Terminal-Operation"><a href="#终止操作：Terminal-Operation" class="headerlink" title="终止操作：Terminal Operation"></a>终止操作：Terminal Operation</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">forEach、forEachOrdered、toArray、reduce、collect、toList、min、</span><br><span class="line">max、count、anyMatch、allMatch、noneMatch、findFirst、findAny、iterator</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="center">方法</th>
<th align="center">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">forEach</td>
<td align="center">循环遍历元素</td>
</tr>
<tr>
<td align="center">forEachOrdered</td>
<td align="center">有序遍历元素（按照元素在流中的顺序）</td>
</tr>
<tr>
<td align="center">toArray</td>
<td align="center">将流中元素转为数组</td>
</tr>
<tr>
<td align="center">reduce</td>
<td align="center">将流中元素进行累计，生成一个单一的结果</td>
</tr>
<tr>
<td align="center">collect</td>
<td align="center">把流转换成某一种集合或者具体操作</td>
</tr>
<tr>
<td align="center">toList</td>
<td align="center">把流转换成list集合</td>
</tr>
<tr>
<td align="center">min</td>
<td align="center">取流中最小的元素</td>
</tr>
<tr>
<td align="center">max</td>
<td align="center">取流中最大的元素</td>
</tr>
<tr>
<td align="center">count</td>
<td align="center">取流中元素的个数</td>
</tr>
<tr>
<td align="center">anyMatch</td>
<td align="center">判断流中元素是否符合某个条件，只要有一个元素符合条件即返回true</td>
</tr>
<tr>
<td align="center">allMatch</td>
<td align="center">同上，不过需要流中所有元素都符合条件才会返回true</td>
</tr>
<tr>
<td align="center">noneMatch</td>
<td align="center">当流为空，或者流中所有元素都不符合条件时，返回true</td>
</tr>
<tr>
<td align="center">findFirst</td>
<td align="center">返回流中第一个元素，串行流是会返回第一个，会返回第一个处理完成的元素，如果同时有多个完成，则返回原始数据中最靠前的</td>
</tr>
<tr>
<td align="center">findAny</td>
<td align="center">返回第一个元素，串行流时和findFirst类似，并行流时会选择第一个，不在意顺序</td>
</tr>
<tr>
<td align="center">iterator</td>
<td align="center">获取流元素的迭代器</td>
</tr>
</tbody></table>
<p>流与集合：</p>
<ul>
<li>集合关注高效数据管理和访问；</li>
<li>流没有提供直接访问或操作其元素的手段，关注声明性地描述源头数据的一系列操作。</li>
</ul>
<h4 id="创建流"><a href="#创建流" class="headerlink" title="创建流"></a>创建流</h4><table>
<thead>
<tr>
<th>方法</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>Stream.of()</td>
<td>创建流并通过可变数组设置流内的元素</td>
</tr>
<tr>
<td>Stream.builder()</td>
<td>创建流，可以通过add方法设置元素，最后通过build方法创建流</td>
</tr>
<tr>
<td>Stream.empty()</td>
<td>创建一个空流</td>
</tr>
<tr>
<td>Stream.ofNullable()</td>
<td>创建一个可能为空的流，如果方法中的元素为空，则是空流，如果不为空则包含元素</td>
</tr>
<tr>
<td>Stream.generate()</td>
<td>通过函数式接口创建流，具体创建流的逻辑可以写在函数式接口中延迟调用</td>
</tr>
<tr>
<td>Stream.concat()</td>
<td>将两个流拼接成一个新流</td>
</tr>
<tr>
<td>Collection.stream()</td>
<td>通过集合对象创建流，集合内的数据即为流中的元素</td>
</tr>
</tbody></table>
<h4 id="流与集合"><a href="#流与集合" class="headerlink" title="流与集合"></a>流与集合</h4><ul>
<li>集合关注高效数据管理和访问</li>
<li>流没有提供直接访问或操作其元素的手段，关注声明性的描述源头数据的一系列操作</li>
</ul>
<h3 id="Reactive-Stream"><a href="#Reactive-Stream" class="headerlink" title="Reactive-Stream"></a>Reactive-Stream</h3><p>Reactive Stream是JVM面向流的库的<font color="#c00000">标准和规范</font></p>
<ul>
<li>处理可能无限数量的元素</li>
<li>有序</li>
<li>在组件之间异步传递元素</li>
<li>强制性<strong>非阻塞</strong>，<strong>背压模式</strong></li>
</ul>
<p><a target="_blank" rel="noopener" href="https://www.reactivemanifesto.org/zh-CN">响应式宣言</a></p>
<p><img src="/2024/01/14/spring/%E5%B0%9A%E7%A1%85%E8%B0%B7springboot3%E5%93%8D%E5%BA%94%E5%BC%8F%E7%BC%96%E7%A8%8B/%E5%93%8D%E5%BA%94%E5%BC%8F%E5%9B%BE%E7%A4%BA.png" alt="响应式图示"></p>
<p>基于异步、消息驱动的全事件回调系统：响应式系统</p>
<p><img src="/2024/01/14/spring/%E5%B0%9A%E7%A1%85%E8%B0%B7springboot3%E5%93%8D%E5%BA%94%E5%BC%8F%E7%BC%96%E7%A8%8B/Reactive%E8%A7%A3%E5%86%B3%E7%9A%84%E9%97%AE%E9%A2%98%E5%9B%BE%E7%A4%BA.png" alt="Reactive解决的问题图示"></p>
<h4 id="Reactive-Stream组件"><a href="#Reactive-Stream组件" class="headerlink" title="Reactive-Stream组件"></a>Reactive-Stream组件</h4><ul>
<li><font color="#c00000">Publisher：发布者</font>；产生数据流</li>
<li><font color="#c00000">Subscriber：订阅者</font>；消费数据流</li>
<li><font color="#c00000">Subscription：订阅关系</font>；<ul>
<li>订阅关系是发布者和订阅者之间的关联接口；订阅者通过订阅来表示对发布者产生的数据感兴趣；订阅者可以请求一定数量的元素，也可以取消订阅。</li>
</ul>
</li>
<li><font color="#c00000">Processor：处理器</font>；<ul>
<li>处理器是同时实现了发布者和订阅者接口的组件；它可以接收来自一个发布者的数据，进行处理，并将结果发布给下一个订阅者；处理器在Reactor中充当中间环节，<font color="#4f81bd">代表一个处理阶段</font>，允许你在数据流中进行转换、过滤和其他操作。</li>
</ul>
</li>
</ul>
<p>这种模型遵循Reactive-Stream规范，确保了异步流的一致性和可靠性。</p>
<p><img src="/2024/01/14/spring/%E5%B0%9A%E7%A1%85%E8%B0%B7springboot3%E5%93%8D%E5%BA%94%E5%BC%8F%E7%BC%96%E7%A8%8B/%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B%E5%9B%BE%E7%A4%BA.png" alt="数据处理流程图示"></p>
<h4 id="响应式编程"><a href="#响应式编程" class="headerlink" title="响应式编程"></a>响应式编程</h4><ul>
<li>底层：基于数据缓冲队列 + 消息驱动模型 + 异步回调机制</li>
<li>编码：流式编程 + 链式调用 + 声明式API</li>
<li>效果：优雅全异步 + 消息实时处理 + 高吞吐量 + 占用少量资源</li>
</ul>
<h2 id="Reactor"><a href="#Reactor" class="headerlink" title="Reactor"></a>Reactor</h2><p>Reactor是基于Reactive Stream的第四代响应式库规范，用于在JVM上构建非阻塞应用程序；<a target="_blank" rel="noopener" href="https://projectreactor.io/">Project Reactor</a></p>
<ol>
<li>完全非阻塞的，并提供高效的需求管理，它直接与java的功能API、CompletableFuture、Stream和Duration交互。</li>
<li>Reactor提供了两种响应式和可组合的API，<font color="#f79646">Flux[N]</font>和<font color="#f79646">Mono[0|1]</font></li>
<li>适合微服务，提供基于netty背压机制网络引擎（HTTP、TCP、UDP）</li>
</ol>
<p>主要概念：</p>
<ul>
<li>发布者（Publisher）</li>
<li>订阅者（Subscriber）</li>
<li>订阅关系（Subscription）</li>
<li>处理器（Processor）</li>
<li>调度器（Scheduler）</li>
<li>事件/信号（event/signal）</li>
<li>序列/流（sequence/stream）</li>
<li>元素（element/item）</li>
<li>操作符（operator）</li>
</ul>
<p><img src="/2024/01/14/spring/%E5%B0%9A%E7%A1%85%E8%B0%B7springboot3%E5%93%8D%E5%BA%94%E5%BC%8F%E7%BC%96%E7%A8%8B/%E5%93%8D%E5%BA%94%E5%BC%8F%E7%BC%96%E7%A8%8B%E6%A8%A1%E5%9E%8B%E5%9B%BE%E7%A4%BA.png" alt="响应式编程模型图示"></p>
<h3 id="快速上手"><a href="#快速上手" class="headerlink" title="快速上手"></a>快速上手</h3><h4 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h4><p>Reactor是一个用于JVM的完全非阻塞的响应式编程框架，具备高效的需求管理（即对“背压（backpressure）”的控制）能力。它与Java8函数式API直接集成，比如<code>CompletableFuture</code>、<code>Stream</code> 以及 <code>Duration</code>。它提供了异步序列API <code>Flux</code>（用于[N]个元素）和 <code>Mono</code> （用于[0|1]个元素），并完全遵循和实现了“响应式扩展规范”（Reactive Extensions Specification）。</p>
<p>Reactor 的 <code>reactor-ipc</code> 组件还支持非阻塞的进程间通信（inter-process communication, IPC）。 Reactor IPC 为 HTTP（包括 Websockets）、TCP 和 UDP 提供了支持背压的网络引擎，从而适合 应用于微服务架构。并且完整支持响应式编解码（reactive encoding and decoding）。</p>
<h4 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.projectreactor<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>reactor-bom<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2023.0.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.projectreactor<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>reactor-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.projectreactor<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>reactor-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span> </span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="响应式编程-1"><a href="#响应式编程-1" class="headerlink" title="响应式编程"></a>响应式编程</h3><blockquote>
<p>响应式编程是一种关注于 <strong>数据流（data streams）</strong> 和 <strong>变化传递（propagation of change）</strong> 的 <strong>异步编程</strong> 方式。<br>这意味着它可以用既有的编程语言表达静态（如数组）或动态（如事件源）的数据流。  </p>
</blockquote>
<p>了解历史：  </p>
<ul>
<li>在响应式编程方面，微软跨出了第一步，它在 .NET 生态中创建了响应式扩展库（Reactive Extensions library, Rx）。接着 RxJava 在JVM上实现了响应式编程。后来，在 JVM 平台出现了一套标准的响应式编程规范，它定义了一系列标准接口和交互规范。并整合到 Java 9 中（使用 Flow 类）。  </li>
<li>响应式编程通常作为面向对象编程中的“观察者模式”（Observer design pattern）的一种扩展。 响应式流（reactive streams）与“迭代子模式”（Iterator design pattern）也有相通之处， 因为其中也有 Iterable-Iterator 这样的对应关系。主要的区别在于，Iterator 是基于 “拉取”（pull）方式的，而响应式流是基于“推送”（push）方式的。  </li>
<li>使用 iterator 是一种“命令式”（imperative）编程范式，即使访问元素的方法是 Iterable 的唯一职责。关键在于，什么时候执行 next() 获取元素取决于开发者。在响应式流中，相对应的 角色是 Publisher-Subscriber，但是 当有新的值到来的时候 ，却反过来由发布者（Publisher） 通知订阅者（Subscriber），这种“推送”模式是响应式的关键。此外，对推送来的数据的操作 是通过一种声明式（declaratively）而不是命令式（imperatively）的方式表达的：开发者通过 描述“控制流程”来定义对数据流的处理逻辑。  </li>
<li>除了数据推送，对错误处理（error handling）和完成（completion）信号的定义也很完善。 一个 Publisher 可以推送新的值到它的 Subscriber（调用 onNext 方法）， 同样也可以推送错误（调用 onError 方法）和完成（调用 onComplete 方法）信号。 错误和完成信号都可以终止响应式流。</li>
</ul>
<h4 id="阻塞是对资源的浪费"><a href="#阻塞是对资源的浪费" class="headerlink" title="阻塞是对资源的浪费"></a>阻塞是对资源的浪费</h4><p>现代应用需要<strong>应对大量的并发用户</strong>，而且即使现代硬件的处理能力飞速发展，<strong>软件性能仍然是关键因素</strong>。<br>广义来说我们有两种思路来提升程序性能：  </p>
<ol>
<li><strong>并行化（parallelize）</strong> ：使用更多的线程和硬件资源。[异步]  </li>
<li>基于现有的资源来 <strong>提高执行效率</strong> 。  </li>
</ol>
<p>通常，Java开发者使用阻塞式（blocking）编写代码。这没有问题，在出现性能瓶颈后， 我们可以增加处理线程，线程中同样是阻塞的代码。但是这种使用资源的方式会迅速面临 资源竞争和并发问题。<br>更糟糕的是，阻塞会浪费资源。具体来说，比如当一个程序面临延迟（通常是I/O方面， 比如数据库读写请求或网络调用），所在线程需要进入 idle 状态等待数据，从而浪费资源。<br>所以，并行化方式并非银弹。这是挖掘硬件潜力的方式，但是却带来了复杂性，而且容易造成浪费。  </p>
<h4 id="异步可以解决问题吗？"><a href="#异步可以解决问题吗？" class="headerlink" title="异步可以解决问题吗？"></a>异步可以解决问题吗？</h4><p>第二种思路——提高执行效率——可以解决资源浪费问题。通过编写 异步非阻塞 的代码， （任务发起异步调用后）执行过程会切换到另一个 <strong>使用同样底层资源</strong> 的活跃任务，然后等 异步调用返回结果再去处理。  </p>
<p>但是在 JVM 上如何编写异步代码呢？Java 提供了两种异步编程方式：  </p>
<ul>
<li>回调（Callbacks） ：异步方法没有返回值，而是采用一个 <font color="#c0504d">callback</font> 作为参数（lambda 或匿名类），当结果出来后回调这个 <font color="#c0504d">callback</font>。常见的例子比如 Swings 的 <font color="#c0504d">EventListener</font>。  </li>
<li>Futures ：异步方法 立即 返回一个 <font color="#c0504d">Future&lt;T&gt; </font>，该异步方法要返回结果的是 <font color="#c0504d">T</font> 类型，通过 <font color="#c0504d">Future</font>封装。这个结果并不是 立刻 可以拿到，而是等实际处理结束才可用。比如， <font color="#c0504d">ExecutorService</font> 执行 <font color="#c0504d">Callable&lt;T&gt;</font> 任务时会返回 Future 对象。  </li>
</ul>
<p>这些技术够用吗？并非对于每个用例都是如此，两种方式都有局限性。<br>回调很难组合起来，因为很快就会导致代码难以理解和维护（即所谓的“回调地狱（callback hell）”）。<br>考虑这样一种情景：  </p>
<ul>
<li>在用户界面上显示用户的5个收藏，或者如果没有任何收藏提供5个建议。  </li>
<li>这需要3个 服务（一个提供收藏的ID列表，第二个服务获取收藏内容，第三个提供建议内容）：<br>回调地狱（Callback Hell）的例子：  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">userService.getFavorites(userId, <span class="keyword">new</span> Callback&lt;List&lt;String&gt;&gt;() &#123; </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(List&lt;String&gt; list)</span> </span>&#123; </span><br><span class="line">    <span class="keyword">if</span> (list.isEmpty()) &#123; </span><br><span class="line">      suggestionService.getSuggestions(<span class="keyword">new</span> Callback&lt;List&lt;Favorite&gt;&gt;() &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(List&lt;Favorite&gt; list)</span> </span>&#123; </span><br><span class="line">          UiUtils.submitOnUiThread(() -&gt; &#123; </span><br><span class="line">            list.stream()</span><br><span class="line">                .limit(<span class="number">5</span>)</span><br><span class="line">                .forEach(uiList::show); </span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable error)</span> </span>&#123; </span><br><span class="line">          UiUtils.errorPopup(error);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      list.stream() </span><br><span class="line">          .limit(<span class="number">5</span>)</span><br><span class="line">          .forEach(favId -&gt; favoriteService.getDetails(favId, </span><br><span class="line">            <span class="keyword">new</span> Callback&lt;Favorite&gt;() &#123;</span><br><span class="line">              <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(Favorite details)</span> </span>&#123;</span><br><span class="line">                UiUtils.submitOnUiThread(() -&gt; uiList.show(details));</span><br><span class="line">              &#125;</span><br><span class="line"></span><br><span class="line">              <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable error)</span> </span>&#123;</span><br><span class="line">                UiUtils.errorPopup(error);</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          ));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable error)</span> </span>&#123;</span><br><span class="line">    UiUtils.errorPopup(error);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></li>
</ul>
<p>Reactor改造后为：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">userService.getFavorites(userId) </span><br><span class="line">           .flatMap(favoriteService::getDetails) </span><br><span class="line">           .switchIfEmpty(suggestionService.getSuggestions()) </span><br><span class="line">           .take(<span class="number">5</span>) </span><br><span class="line">           .publishOn(UiUtils.uiThreadScheduler()) </span><br><span class="line">           .subscribe(uiList::show, UiUtils::errorPopup); </span><br></pre></td></tr></table></figure>
<p>如果你想确保“收藏的ID”的数据在800ms内获得（如果超时，从缓存中获取）呢？在基于回调的代码中， 会比较复杂。但 Reactor 中就很简单，在处理链中增加一个 timeout 的操作符即可。  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">userService.getFavorites(userId)</span><br><span class="line">           .timeout(Duration.ofMillis(<span class="number">800</span>)) </span><br><span class="line">           .onErrorResume(cacheService.cachedFavoritesFor(userId)) </span><br><span class="line">           .flatMap(favoriteService::getDetails) </span><br><span class="line">           .switchIfEmpty(suggestionService.getSuggestions())</span><br><span class="line">           .take(<span class="number">5</span>)</span><br><span class="line">           .publishOn(UiUtils.uiThreadScheduler())</span><br><span class="line">           .subscribe(uiList::show, UiUtils::errorPopup);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>额外扩展：<br>Futures 比回调要好一点，但即使在 Java 8 引入了 <font color="#c0504d">CompletableFuture</font>，它对于多个处理的组合仍不够好用。 编排多个 Futures 是可行的，但却不易。此外，<font color="#c0504d">Future</font> 还有一个问题：当对 <font color="#c0504d">Future</font> 对象最终调用 <font color="#c0504d">get()</font> 方法时，仍然会导致阻塞，并且缺乏对多个值以及更进一步对错误的处理。<br>考虑另外一个例子，我们首先得到 ID 的列表，然后通过它进一步获取到“对应的 name 和 statistics” 为元素的列表，整个过程用异步方式来实现。<br>CompletableFuture 处理组合的例子 : </p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">CompletableFuture&lt;List&lt;String&gt;&gt; ids = ifhIds(); </span><br><span class="line"></span><br><span class="line">CompletableFuture&lt;List&lt;String&gt;&gt; result = ids.thenComposeAsync(l -&gt; &#123; </span><br><span class="line">        Stream&lt;CompletableFuture&lt;String&gt;&gt; zip =</span><br><span class="line">                        l.stream().map(i -&gt; &#123; </span><br><span class="line">CompletableFuture&lt;String&gt; nameTask = ifhName(i); </span><br><span class="line">CompletableFuture&lt;Integer&gt; statTask = ifhStat(i); </span><br><span class="line">    <span class="keyword">return</span> nameTask.thenCombineAsync(statTask, (name, stat) -&gt; <span class="string">&quot;Name &quot;</span> + name + <span class="string">&quot; has stats &quot;</span> + stat); &#125;);</span><br><span class="line">List&lt;CompletableFuture&lt;String&gt;&gt; combinationList = zip.collect(Collectors.toList()); </span><br><span class="line">        CompletableFuture&lt;String&gt;[] combinationArray = combinationList.toArray(<span class="keyword">new</span> CompletableFuture[combinationList.size()]);</span><br><span class="line">        CompletableFuture&lt;Void&gt; allDone = CompletableFuture.allOf(combinationArray); </span><br><span class="line">        <span class="keyword">return</span> allDone.thenApply(v -&gt; combinationList.stream()</span><br><span class="line">                                                                           .map(CompletableFuture::join) </span><br><span class="line">                                                                       .collect(Collectors.toList()));</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">List&lt;String&gt; results = result.join(); </span><br><span class="line">assertThat(results).contains(</span><br><span class="line">                        <span class="string">&quot;Name NameJoe has stats 103&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;Name NameBart has stats 104&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;Name NameHenry has stats 105&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;Name NameNicole has stats 106&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;Name NameABSLAJNFOAJNFOANFANSF has stats 121&quot;</span>);</span><br></pre></td></tr></table></figure>

<h4 id="从命令式编程到响应式编程"><a href="#从命令式编程到响应式编程" class="headerlink" title="从命令式编程到响应式编程"></a>从命令式编程到响应式编程</h4><p>类似 Reactor 这样的响应式库的目标就是要弥补上述“经典”的 JVM 异步方式所带来的不足， 此外还会关注一下几个方面：  </p>
<ul>
<li><strong>可编排性（Composability）</strong> 以及 <strong>可读性（Readability）</strong>  </li>
<li>使用丰富的 <strong>操作符</strong> 来处理形如 <strong>流</strong> 的数据  </li>
<li>在 <strong>订阅（subscribe）</strong> 之前什么都不会发生  </li>
<li><strong>背压（backpressure）</strong> 具体来说即 消费者能够反向告知生产者生产内容的速度的能力  </li>
<li><strong>高层次</strong> （同时也是有高价值的）的抽象，从而达到 并发无关 的效果  </li>
</ul>
<h5 id="可编排性与可读性"><a href="#可编排性与可读性" class="headerlink" title="可编排性与可读性"></a>可编排性与可读性</h5><p>可编排性，指的是编排多个异步任务的能力。比如我们将前一个任务的结果传递给后一个任务作为输入， 或者将多个任务以分解再汇总（fork-join）的形式执行，或者将异步的任务作为离散的组件在系统中 进行重用。<br>这种编排任务的能力与代码的可读性和可维护性是紧密相关的。随着异步处理任务数量和复杂度 的提高，编写和阅读代码都变得越来越困难。就像我们刚才看到的，回调模式是简单的，但是缺点 是在复杂的处理逻辑中，回调中会层层嵌入回调，导致 <strong>回调地狱（Callback Hell）</strong> 。你能猜到 （或有过这种痛苦经历），这样的代码是难以阅读和分析的。<br>Reactor 提供了丰富的编排操作，从而代码直观反映了处理流程，并且所有的操作保持在同一层次 （尽量避免了嵌套）。  </p>
<h5 id="就像装配流水线"><a href="#就像装配流水线" class="headerlink" title="就像装配流水线"></a>就像装配流水线</h5><p>你可以想象数据在响应式应用中的处理，就像流过一条装配流水线。Reactor 既是传送带， 又是一个个的装配工或机器人。原材料从源头（最初的 Publisher）流出，最终被加工为成品， 等待被推送到消费者（或者说 Subscriber）。<br>原材料会经过不同的中间处理过程，或者作为半成品与其他半成品进行组装。如果某处有齿轮卡住， 或者某件产品的包装过程花费了太久时间，相应的工位就可以向上游发出信号来限制或停止发出原材料。  </p>
<h5 id="操作符（Operators）"><a href="#操作符（Operators）" class="headerlink" title="操作符（Operators）"></a>操作符（Operators）</h5><p>在 Reactor 中，操作符（operator）就像装配线中的工位（操作员或装配机器人）。<font color="#c0504d">每一个操作符 对 Publisher 进行相应的处理，然后将 Publisher 包装为一个新的 Publisher。</font>就像一个链条， 数据源自第一个 Publisher，然后顺链条而下，在每个环节进行相应的处理。<font color="#c0504d">最终，一个订阅者 (Subscriber）终结这个过程。</font>请记住，<font color="#c0504d">在订阅者（Subscriber）订阅（subscribe）到一个 发布者（Publisher）之前，什么都不会发生。</font> </p>
<blockquote>
<p>理解了操作符会创建新的 <font color="#c0504d">Publisher</font> 实例这一点，能够帮助你避免一个常见的问题， 这种问题会让你觉得处理链上的某个操作符没有起作用。  </p>
</blockquote>
<p>虽然响应式流规范（Reactive Streams specification）没有规定任何操作符， 类似 Reactor 这样的响应式库所带来的最大附加价值之一就是提供丰富的操作符。包括基础的转换操作， 到过滤操作，甚至复杂的编排和错误处理操作。  </p>
<h5 id="subscribe-之前什么都不会发生"><a href="#subscribe-之前什么都不会发生" class="headerlink" title="subscribe() 之前什么都不会发生"></a>subscribe() 之前什么都不会发生</h5><p>在 Reactor 中，当你创建了一条 Publisher 处理链，数据还不会开始生成。事实上，你是创建了 一种抽象的对于异步处理流程的描述（从而方便重用和组装）。<br>当真正“订阅（subscrib）”的时候，你需要将 Publisher 关联到一个 Subscriber 上，然后 才会触发整个链的流动。这时候，Subscriber 会向上游发送一个 request 信号，一直到达源头 的 Publisher。  </p>
<h5 id="背压"><a href="#背压" class="headerlink" title="背压"></a>背压</h5><p>向上游传递信号这一点也被用于实现 <strong>背压</strong> ，就像在装配线上，某个工位的处理速度如果慢于流水线 速度，会对上游发送反馈信号一样。</p>
<p>在响应式流规范中实际定义的机制同刚才的类比非常接近：订阅者可以无限接受数据并让它的源头 “满负荷”推送所有的数据，也可以通过使用 <font color="#c0504d">request</font> 机制来告知源头它一次最多能够处理 <font color="#c0504d">n</font> 个元素。<br>中间环节的操作也可以影响 <font color="#c0504d">request</font>。想象一个能够将每10个元素分批打包的缓存（<font color="#c0504d">buffer</font>）操作。 如果订阅者请求一个元素，那么对于源头来说可以生成10个元素。此外预取策略也可以使用了， 比如在订阅前预先生成元素。<br><strong>这样能够将“推送”模式转换为“推送+拉取”混合的模式，如果下游准备好了，可以从上游拉取 n 个元素；但是如果上游元素还没有准备好，下游还是要等待上游的推送。</strong>  </p>
<h5 id="热（Hot）-vs-冷（Cold）"><a href="#热（Hot）-vs-冷（Cold）" class="headerlink" title="热（Hot） vs 冷（Cold）"></a>热（Hot） vs 冷（Cold）</h5><p>在 Rx 家族的响应式库中，响应式流分为“热”和“冷”两种类型，区别主要在于响应式流如何 对订阅者进行响应：  </p>
<ul>
<li>一个“冷”的序列，指对于每一个 Subscriber，都会收到从头开始所有的数据。如果源头 生成了一个 HTTP 请求，对于每一个订阅都会创建一个新的 HTTP 请求。  </li>
<li>一个“热”的序列，指对于一个 Subscriber，只能获取从它开始 订阅 之后 发出的数据。不过注意，有些“热”的响应式流可以缓存部分或全部历史数据。 通常意义上来说，一个“热”的响应式流，甚至在即使没有订阅者接收数据的情况下，也可以 发出数据（这一点同 “Subscribe() 之前什么都不会发生”的规则有冲突）。  </li>
</ul>
<h3 id="核心特性"><a href="#核心特性" class="headerlink" title="核心特性"></a>核心特性</h3><h4 id="Mono和Flux"><a href="#Mono和Flux" class="headerlink" title="Mono和Flux"></a>Mono和Flux</h4><p>Mono: 0|1 数据流<br>Flux: N数据流  </p>
<p>响应式流：元素（内容） + 信号（完成/异常）；  </p>
<h4 id="subscribe"><a href="#subscribe" class="headerlink" title="subscribe()"></a>subscribe()</h4><p>自定义流的信号感知回调  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">flux.subscribe(</span><br><span class="line">        v-&gt; System.out.println(<span class="string">&quot;v = &quot;</span> + v), <span class="comment">//流元素消费</span></span><br><span class="line">        throwable -&gt; System.out.println(<span class="string">&quot;throwable = &quot;</span> + throwable), <span class="comment">//感知异常结束</span></span><br><span class="line">        ()-&gt; System.out.println(<span class="string">&quot;流结束了...&quot;</span>) <span class="comment">//感知正常结束</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>自定义消费者  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">flux.subscribe(<span class="keyword">new</span> BaseSubscriber&lt;String&gt;() &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 生命周期钩子1： 订阅关系绑定的时候触发</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">hookOnSubscribe</span><span class="params">(Subscription subscription)</span> </span>&#123;</span><br><span class="line">                <span class="comment">// 流被订阅的时候触发</span></span><br><span class="line">                System.out.println(<span class="string">&quot;绑定了...&quot;</span>+subscription);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//找发布者要数据</span></span><br><span class="line">                request(<span class="number">1</span>); <span class="comment">//要1个数据</span></span><br><span class="line"><span class="comment">//                requestUnbounded(); //要无限数据</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">hookOnNext</span><span class="params">(String value)</span> </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;数据到达，正在处理：&quot;</span>+value);</span><br><span class="line">                request(<span class="number">1</span>); <span class="comment">//要1个数据</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment">//  hookOnComplete、hookOnError 二选一执行</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">hookOnComplete</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;流正常结束...&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">hookOnError</span><span class="params">(Throwable throwable)</span> </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;流异常...&quot;</span>+throwable);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">hookOnCancel</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;流被取消...&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">hookFinally</span><span class="params">(SignalType type)</span> </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;最终回调...一定会被执行&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure>
<h4 id="流的取消"><a href="#流的取消" class="headerlink" title="流的取消"></a>流的取消</h4><blockquote>
<p>消费者调用 cancle() 取消流的订阅；<br><font color="#4f81bd">Disposable</font>  </p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">        Flux&lt;String&gt; flux = Flux.range(<span class="number">1</span>, <span class="number">10</span>)</span><br><span class="line">                .map(i -&gt; &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;map...&quot;</span>+i);</span><br><span class="line">                    <span class="keyword">if</span>(i==<span class="number">9</span>) &#123;</span><br><span class="line">                        i = <span class="number">10</span>/(<span class="number">9</span>-i); <span class="comment">//数学运算异常;  doOnXxx</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> <span class="string">&quot;哈哈：&quot;</span> + i;</span><br><span class="line">                &#125;); <span class="comment">//流错误的时候，把错误吃掉，转为正常信号</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//        flux.subscribe(); //流被订阅; 默认订阅；</span></span><br><span class="line"><span class="comment">//        flux.subscribe(v-&gt; System.out.println(&quot;v = &quot; + v));//指定订阅规则： 正常消费者：只消费正常元素</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//        flux.subscribe(</span></span><br><span class="line"><span class="comment">//                v-&gt; System.out.println(&quot;v = &quot; + v), //流元素消费</span></span><br><span class="line"><span class="comment">//                throwable -&gt; System.out.println(&quot;throwable = &quot; + throwable), //感知异常结束</span></span><br><span class="line"><span class="comment">//                ()-&gt; System.out.println(&quot;流结束了...&quot;) //感知正常结束</span></span><br><span class="line"><span class="comment">//        );</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 流的生命周期钩子可以传播给订阅者。</span></span><br><span class="line">        <span class="comment">//  a() &#123;</span></span><br><span class="line">        <span class="comment">//      data = b();</span></span><br><span class="line">        <span class="comment">//  &#125;</span></span><br><span class="line">        flux.subscribe(<span class="keyword">new</span> BaseSubscriber&lt;String&gt;() &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 生命周期钩子1： 订阅关系绑定的时候触发</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">hookOnSubscribe</span><span class="params">(Subscription subscription)</span> </span>&#123;</span><br><span class="line">                <span class="comment">// 流被订阅的时候触发</span></span><br><span class="line">                System.out.println(<span class="string">&quot;绑定了...&quot;</span>+subscription);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//找发布者要数据</span></span><br><span class="line">                request(<span class="number">1</span>); <span class="comment">//要1个数据</span></span><br><span class="line"><span class="comment">//                requestUnbounded(); //要无限数据</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">hookOnNext</span><span class="params">(String value)</span> </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;数据到达，正在处理：&quot;</span>+value);</span><br><span class="line">                <span class="keyword">if</span>(value.equals(<span class="string">&quot;哈哈：5&quot;</span>))&#123;</span><br><span class="line">                    cancel(); <span class="comment">//取消流</span></span><br><span class="line">                &#125;</span><br><span class="line">                request(<span class="number">1</span>); <span class="comment">//要1个数据</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment">//  hookOnComplete、hookOnError 二选一执行</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">hookOnComplete</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;流正常结束...&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">hookOnError</span><span class="params">(Throwable throwable)</span> </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;流异常...&quot;</span>+throwable);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">hookOnCancel</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;流被取消...&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">hookFinally</span><span class="params">(SignalType type)</span> </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;最终回调...一定会被执行&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure>
<h4 id="BaseSubscriber"><a href="#BaseSubscriber" class="headerlink" title="BaseSubscriber"></a>BaseSubscriber</h4><p>自定义消费者，推荐直接编写 <font color="#4f81bd">BaseSubscriber 的逻辑</font>；  </p>
<h4 id="背压（Backpressure-）和请求重塑（Reshape-Requests）"><a href="#背压（Backpressure-）和请求重塑（Reshape-Requests）" class="headerlink" title="背压（Backpressure ）和请求重塑（Reshape Requests）"></a>背压（Backpressure ）和请求重塑（Reshape Requests）</h4><h5 id="buffer：缓冲"><a href="#buffer：缓冲" class="headerlink" title="buffer：缓冲"></a>buffer：缓冲</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Flux&lt;List&lt;Integer&gt;&gt; flux = Flux.range(<span class="number">1</span>, <span class="number">10</span>)  <span class="comment">//原始流10个</span></span><br><span class="line">        .buffer(<span class="number">3</span>)</span><br><span class="line">        .log();<span class="comment">//缓冲区：缓冲3个元素: 消费一次最多可以拿到三个元素； 凑满数批量发给消费者</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//        //一次发一个，一个一个发；</span></span><br><span class="line"><span class="comment">// 10元素，buffer(3)；消费者请求4次，数据消费完成</span></span><br></pre></td></tr></table></figure>
<h5 id="limit：限流"><a href="#limit：限流" class="headerlink" title="limit：限流"></a>limit：限流</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Flux.range(<span class="number">1</span>, <span class="number">1000</span>)</span><br><span class="line">    .log()</span><br><span class="line">    <span class="comment">//限流触发，看上游是怎么限流获取数据的</span></span><br><span class="line">    .limitRate(<span class="number">100</span>) <span class="comment">//一次预取30个元素； 第一次 request(100)，以后request(75)</span></span><br><span class="line">    .subscribe();</span><br></pre></td></tr></table></figure>

<h4 id="以编程方式创建序列-Sink"><a href="#以编程方式创建序列-Sink" class="headerlink" title="以编程方式创建序列-Sink"></a>以编程方式创建序列-Sink</h4><blockquote>
<p>Sink.next<br>Sink.complete  </p>
</blockquote>
<h5 id="同步环境-generate"><a href="#同步环境-generate" class="headerlink" title="同步环境-generate"></a>同步环境-generate</h5><h5 id="多线程-create"><a href="#多线程-create" class="headerlink" title="多线程-create"></a>多线程-create</h5><h4 id="handle"><a href="#handle" class="headerlink" title="handle()"></a>handle()</h4><p>自定义流中元素处理规则  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line">     Flux.range(<span class="number">1</span>,<span class="number">10</span>)</span><br><span class="line">             .handle((value,sink)-&gt;&#123;</span><br><span class="line">                 System.out.println(<span class="string">&quot;拿到的值：&quot;</span>+value);</span><br><span class="line">                 sink.next(<span class="string">&quot;张三：&quot;</span>+value); <span class="comment">//可以向下发送数据的通道</span></span><br><span class="line">             &#125;)</span><br><span class="line">             .log() <span class="comment">//日志</span></span><br><span class="line">             .subscribe();</span><br></pre></td></tr></table></figure>

<h4 id="自定义线程调度"><a href="#自定义线程调度" class="headerlink" title="自定义线程调度"></a>自定义线程调度</h4><blockquote>
<p>响应式：响应式编程： 全异步、消息、事件回调<br>默认还是用当前线程，生成整个流、发布流、流操作  </p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">thread1</span><span class="params">()</span></span>&#123;</span><br><span class="line">    Scheduler s = Schedulers.newParallel(<span class="string">&quot;parallel-scheduler&quot;</span>, <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> Flux&lt;String&gt; flux = Flux</span><br><span class="line">            .range(<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line">            .map(i -&gt; <span class="number">10</span> + i)</span><br><span class="line">            .log()</span><br><span class="line">            .publishOn(s)</span><br><span class="line">            .map(i -&gt; <span class="string">&quot;value &quot;</span> + i)</span><br><span class="line">            ;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//只要不指定线程池，默认发布者用的线程就是订阅者的线程；</span></span><br><span class="line">    <span class="keyword">new</span> Thread(() -&gt; flux.subscribe(System.out::println)).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="错误处理"><a href="#错误处理" class="headerlink" title="错误处理"></a>错误处理</h4><p>命令式编程：常见的错误处理方式  </p>
<h5 id="Catch-and-return-a-static-default-value-捕获异常返回一个静态默认值"><a href="#Catch-and-return-a-static-default-value-捕获异常返回一个静态默认值" class="headerlink" title="Catch and return a static default value. 捕获异常返回一个静态默认值"></a>Catch and return a static default value. 捕获异常返回一个静态默认值</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> doSomethingDangerous(<span class="number">10</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (Throwable error) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;RECOVERED&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>onErrorReturn: 实现上面效果，错误的时候返回一个值<br>1、吃掉异常，消费者无异常感知<br>2、返回一个兜底默认值<br>3、流正常完成； </p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Flux.just(<span class="number">1</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">4</span>)</span><br><span class="line">        .map(i -&gt; <span class="string">&quot;100 / &quot;</span> + i + <span class="string">&quot; = &quot;</span> + (<span class="number">100</span> / i))</span><br><span class="line">        .onErrorReturn(NullPointerException.class,<span class="string">&quot;哈哈-6666&quot;</span>)</span><br><span class="line">        .subscribe(v-&gt; System.out.println(<span class="string">&quot;v = &quot;</span> + v),</span><br><span class="line">                err -&gt; System.out.println(<span class="string">&quot;err = &quot;</span> + err),</span><br><span class="line">                ()-&gt; System.out.println(<span class="string">&quot;流结束&quot;</span>)); <span class="comment">// error handling example</span></span><br></pre></td></tr></table></figure>
<h5 id="Catch-and-execute-an-alternative-path-with-a-fallback-method-吃掉异常，执行一个兜底方法；"><a href="#Catch-and-execute-an-alternative-path-with-a-fallback-method-吃掉异常，执行一个兜底方法；" class="headerlink" title="Catch and execute an alternative path with a fallback method.  吃掉异常，执行一个兜底方法；"></a>Catch and execute an alternative path with a fallback method.  吃掉异常，执行一个兜底方法；</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> doSomethingDangerous(<span class="number">10</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (Throwable error) &#123;</span><br><span class="line">  <span class="keyword">return</span> doOtherthing(<span class="number">10</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>onErrorResume<br>1、吃掉异常，消费者无异常感知<br>2、调用一个兜底方法<br>3、流正常完成  </p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Flux.just(<span class="number">1</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">4</span>)</span><br><span class="line">        .map(i -&gt; <span class="string">&quot;100 / &quot;</span> + i + <span class="string">&quot; = &quot;</span> + (<span class="number">100</span> / i)).onErrorResume(err -&gt; Mono.just(<span class="string">&quot;哈哈-777&quot;</span>))</span><br><span class="line">        .subscribe(v -&gt; System.out.println(<span class="string">&quot;v = &quot;</span> + v),</span><br><span class="line">                err -&gt; System.out.println(<span class="string">&quot;err = &quot;</span> + err),</span><br><span class="line">                () -&gt; System.out.println(<span class="string">&quot;流结束&quot;</span>));</span><br></pre></td></tr></table></figure>

<h5 id="Catch-and-dynamically-compute-a-fallback-value-捕获并动态计算一个返回值"><a href="#Catch-and-dynamically-compute-a-fallback-value-捕获并动态计算一个返回值" class="headerlink" title="Catch and dynamically compute a fallback value. 捕获并动态计算一个返回值"></a>Catch and dynamically compute a fallback value. 捕获并动态计算一个返回值</h5><blockquote>
<p>根据错误返回一个新值  </p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  Value v = erroringMethod();</span><br><span class="line">  <span class="keyword">return</span> MyWrapper.fromValue(v);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (Throwable error) &#123;</span><br><span class="line">  <span class="keyword">return</span> MyWrapper.fromError(error);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.onErrorResume(err -&gt; Flux.error(<span class="keyword">new</span> BusinessException(err.getMessage()+<span class="string">&quot;：炸了&quot;</span>)))</span><br></pre></td></tr></table></figure>

<blockquote>
<p>1、吃掉异常，消费者有感知<br>2、调用一个自定义方法<br>3、流异常完成  </p>
</blockquote>
<h5 id="Catch-wrap-to-a-BusinessException-and-re-throw-捕获并包装成一个业务异常，并重新抛出"><a href="#Catch-wrap-to-a-BusinessException-and-re-throw-捕获并包装成一个业务异常，并重新抛出" class="headerlink" title="Catch, wrap to a BusinessException, and re-throw.  捕获并包装成一个业务异常，并重新抛出"></a>Catch, wrap to a BusinessException, and re-throw.  捕获并包装成一个业务异常，并重新抛出</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> callExternalService(k);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (Throwable error) &#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> BusinessException(<span class="string">&quot;oops, SLA exceeded&quot;</span>, error);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>包装重新抛出异常: 推荐用 .onErrorMap<br>1、吃掉异常，消费者有感知<br>2、抛新异常<br>3、流异常完成  </p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">.onErrorResume(err -&gt; Flux.error(<span class="keyword">new</span> BusinessException(err.getMessage()+<span class="string">&quot;：炸了&quot;</span>)))</span><br><span class="line"></span><br><span class="line">        Flux.just(<span class="number">1</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">4</span>)</span><br><span class="line">                .map(i -&gt; <span class="string">&quot;100 / &quot;</span> + i + <span class="string">&quot; = &quot;</span> + (<span class="number">100</span> / i))</span><br><span class="line">                .onErrorMap(err-&gt; <span class="keyword">new</span> BusinessException(err.getMessage()+<span class="string">&quot;: 又炸了...&quot;</span>))</span><br><span class="line">                .subscribe(v -&gt; System.out.println(<span class="string">&quot;v = &quot;</span> + v),</span><br><span class="line">                        err -&gt; System.out.println(<span class="string">&quot;err = &quot;</span> + err),</span><br><span class="line">                        () -&gt; System.out.println(<span class="string">&quot;流结束&quot;</span>));</span><br></pre></td></tr></table></figure>
<h5 id="Catch-log-an-error-specific-message-and-re-throw-捕获异常，记录特殊的错误日志，重新抛出"><a href="#Catch-log-an-error-specific-message-and-re-throw-捕获异常，记录特殊的错误日志，重新抛出" class="headerlink" title="Catch, log an error-specific message, and re-throw.  捕获异常，记录特殊的错误日志，重新抛出"></a>Catch, log an error-specific message, and re-throw.  捕获异常，记录特殊的错误日志，重新抛出</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> callExternalService(k);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (RuntimeException error) &#123;</span><br><span class="line">  <span class="comment">//make a record of the error</span></span><br><span class="line">  log(<span class="string">&quot;uh oh, falling back, service failed for key &quot;</span> + k);</span><br><span class="line">  <span class="keyword">throw</span> error;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>异常被捕获、做自己的事情<br>不影响异常继续顺着流水线传播<br>1、不吃掉异常，只在异常发生的时候做一件事，消费者有感知  </p>
</blockquote>
<h5 id="Use-the-finally-block-to-clean-up-resources-or-a-Java-7-“try-with-resource”-construct"><a href="#Use-the-finally-block-to-clean-up-resources-or-a-Java-7-“try-with-resource”-construct" class="headerlink" title="Use the finally block to clean up resources or a Java 7 “try-with-resource” construct."></a>Use the finally block to clean up resources or a Java 7 “try-with-resource” construct.</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Flux.just(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>)</span><br><span class="line">        .map(i -&gt; <span class="string">&quot;100 / &quot;</span> + i + <span class="string">&quot; = &quot;</span> + (<span class="number">100</span> / i))</span><br><span class="line">        .doOnError(err -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;err已被记录 = &quot;</span> + err);</span><br><span class="line">        &#125;)</span><br><span class="line">        .doFinally(signalType -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;流信号：&quot;</span>+signalType);</span><br><span class="line">        &#125;)</span><br></pre></td></tr></table></figure>

<h5 id="忽略当前异常，仅通知记录，继续推进"><a href="#忽略当前异常，仅通知记录，继续推进" class="headerlink" title="忽略当前异常，仅通知记录，继续推进"></a>忽略当前异常，仅通知记录，继续推进</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Flux.just(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">0</span>,<span class="number">5</span>)</span><br><span class="line">        .map(i-&gt;<span class="number">10</span>/i)</span><br><span class="line">        .onErrorContinue((err,val)-&gt;&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;err = &quot;</span> + err);</span><br><span class="line">            System.out.println(<span class="string">&quot;val = &quot;</span> + val);</span><br><span class="line">            System.out.println(<span class="string">&quot;发现&quot;</span>+val+<span class="string">&quot;有问题了，继续执行其他的，我会记录这个问题&quot;</span>);</span><br><span class="line">        &#125;) <span class="comment">//发生</span></span><br><span class="line">        .subscribe(v-&gt; System.out.println(<span class="string">&quot;v = &quot;</span> + v),</span><br><span class="line">                err-&gt; System.out.println(<span class="string">&quot;err = &quot;</span> + err));</span><br></pre></td></tr></table></figure>

<h4 id="常用操作"><a href="#常用操作" class="headerlink" title="常用操作"></a>常用操作</h4><p>filter、flatMap、concatMap、flatMapMany、transform、defaultIfEmpty、switchIfEmpty、concat、concatWith、merge、mergeWith、mergeSequential、zip、zipWith…  </p>
<p><strong>Context-API</strong>：响应式中的ThreadLocal</p>
<ul>
<li>ThreadLocal机制失效(响应式编程是基于异步的，ThreadLocal只能在同线程内调用，所以响应式编程中无法使用)<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Flux.just(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>)</span><br><span class="line">        .transformDeferredContextual((flux,context)-&gt;&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;flux = &quot;</span> + flux);</span><br><span class="line">            System.out.println(<span class="string">&quot;context = &quot;</span> + context);</span><br><span class="line">            <span class="keyword">return</span> flux.map(i-&gt;i+<span class="string">&quot;==&gt;&quot;</span>+context.get(<span class="string">&quot;prefix&quot;</span>));</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="comment">//上游能拿到下游的最近一次数据</span></span><br><span class="line">        .contextWrite(Context.of(<span class="string">&quot;prefix&quot;</span>,<span class="string">&quot;哈哈&quot;</span>))</span><br><span class="line">        <span class="comment">//ThreadLocal共享了数据，上游的所有人能看到; Context由下游传播给上游</span></span><br><span class="line">        .subscribe(v-&gt; System.out.println(<span class="string">&quot;v = &quot;</span> + v));</span><br></pre></td></tr></table></figure></li>
</ul>
<p><strong>ParallelFlux</strong></p>
<ul>
<li>并行流<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">        Flux.range(<span class="number">1</span>,<span class="number">1000000</span>)</span><br><span class="line">                .buffer(<span class="number">100</span>)</span><br><span class="line">                .parallel(<span class="number">8</span>)</span><br><span class="line">                .runOn(Schedulers.newParallel(<span class="string">&quot;yy&quot;</span>))</span><br><span class="line">.log()</span><br><span class="line">.subscribe();</span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="Spring-Webflux"><a href="#Spring-Webflux" class="headerlink" title="Spring Webflux"></a>Spring Webflux</h1><blockquote>
<p>WebFlux：底层完全基于netty+reactor+springweb 完成一个全异步非阻塞的web<strong>响应式框架</strong><br><strong>底层：异步 + 消息队列(内存) + 事件回调机制 = 整套系统</strong><br><strong>优点：能使用少量资源处理大量请求；</strong></p>
</blockquote>
<h2 id="组件对比"><a href="#组件对比" class="headerlink" title="组件对比"></a>组件对比</h2><table>
<thead>
<tr>
<th>API功能</th>
<th>Servlet-阻塞式Web</th>
<th>WebFlux-响应式Web</th>
</tr>
</thead>
<tbody><tr>
<td>前端控制器</td>
<td>DispatcherServlet</td>
<td>DispatcherHandler</td>
</tr>
<tr>
<td>处理器</td>
<td>Controller</td>
<td>WebHandler/Controller</td>
</tr>
<tr>
<td>请求、响应</td>
<td><strong>ServletRequest</strong>、<strong>ServletResponse</strong></td>
<td><strong>ServerWebExchange：</strong><br><br><strong>ServerHttpRequest、ServerHttpResponse</strong></td>
</tr>
<tr>
<td>过滤器</td>
<td>Filter（HttpFilter）</td>
<td>WebFilter</td>
</tr>
<tr>
<td>异常处理器</td>
<td>HandlerExceptionResolver</td>
<td>DispatchExceptionHandler</td>
</tr>
<tr>
<td>Web配置</td>
<td>@EnableWebMvc</td>
<td>@EnableWebFlux</td>
</tr>
<tr>
<td>自定义配置</td>
<td>WebMvcConfigurer</td>
<td>WebFluxConfigurer</td>
</tr>
<tr>
<td>返回结果</td>
<td>任意</td>
<td><strong>Mono、Flux</strong>、任意</td>
</tr>
<tr>
<td>发送REST请求</td>
<td>RestTemplate</td>
<td>WebClient</td>
</tr>
</tbody></table>
<p><strong>Mono： 返回0|1 数据流</strong><br><strong>Flux：返回N数据流</strong></p>
<h2 id="WebFlux"><a href="#WebFlux" class="headerlink" title="WebFlux"></a>WebFlux</h2><blockquote>
<p>底层基于Netty实现的Web容器与请求/响应处理机制<br><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/reference/6.0/web/webflux.html">Spring WebFlux :: Spring Framework</a></p>
</blockquote>
<h3 id="引入"><a href="#引入" class="headerlink" title="引入"></a>引入</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-webflux<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>Context 响应式上下文数据传递； 由下游传播给上游；</strong><br><strong>以前： 浏览器 –&gt; Controller –&gt; Service –&gt; Dao： 阻塞式编程</strong><br>**<font color="#953734">现在： Dao（数据源查询对象【数据发布者】） –&gt; Service –&gt; Controller –&gt; 浏览器： 响应式</font></p>
</blockquote>
<blockquote>
<p><strong>大数据流程： 从一个数据源拿到大量数据进行分析计算；</strong><br>ProductVistorDao.loadData()<br>                .distinct()<br>                .map()<br>                .filter()<br>                .handle()<br>                .subscribe();<br> //加载最新的商品浏览数据</p>
</blockquote>
<p><img src="/2024/01/14/spring/%E5%B0%9A%E7%A1%85%E8%B0%B7springboot3%E5%93%8D%E5%BA%94%E5%BC%8F%E7%BC%96%E7%A8%8B/SpringMVC-SpringWebFlux%E5%AF%B9%E6%AF%94%E5%9B%BE%E7%A4%BA.png" alt="SpringMVC-SpringWebFlux对比图示"></p>
<h3 id="Reactor-Core"><a href="#Reactor-Core" class="headerlink" title="Reactor Core"></a>Reactor Core</h3><h4 id="HttpHandler、HttpServer"><a href="#HttpHandler、HttpServer" class="headerlink" title="HttpHandler、HttpServer"></a>HttpHandler、HttpServer</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">//快速自己编写一个能处理请求的服务器</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//1、创建一个能处理Http请求的处理器。 参数：请求、响应； 返回值：Mono&lt;Void&gt;：代表处理完成的信号</span></span><br><span class="line">        HttpHandler handler = (ServerHttpRequest request,</span><br><span class="line">                                   ServerHttpResponse response)-&gt;&#123;</span><br><span class="line">            URI uri = request.getURI();</span><br><span class="line">            System.out.println(Thread.currentThread()+<span class="string">&quot;请求进来：&quot;</span>+uri);</span><br><span class="line">            <span class="comment">//编写请求处理的业务,给浏览器写一个内容 URL + &quot;Hello~!&quot;</span></span><br><span class="line"><span class="comment">//            response.getHeaders(); //获取响应头</span></span><br><span class="line"><span class="comment">//            response.getCookies(); //获取Cookie</span></span><br><span class="line"><span class="comment">//            response.getStatusCode(); //获取响应状态码；</span></span><br><span class="line"><span class="comment">//            response.bufferFactory(); //buffer工厂</span></span><br><span class="line"><span class="comment">//            response.writeWith() //把xxx写出去</span></span><br><span class="line"><span class="comment">//            response.setComplete(); //响应结束</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//数据的发布者：Mono&lt;DataBuffer&gt;、Flux&lt;DataBuffer&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//创建 响应数据的 DataBuffer</span></span><br><span class="line">            DataBufferFactory factory = response.bufferFactory();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//数据Buffer</span></span><br><span class="line">            DataBuffer buffer = factory.wrap(<span class="keyword">new</span> String(uri.toString() + <span class="string">&quot; ==&gt; Hello!&quot;</span>).getBytes());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 需要一个 DataBuffer 的发布者</span></span><br><span class="line">            <span class="keyword">return</span> response.writeWith(Mono.just(buffer));</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2、启动一个服务器，监听8080端口，接受数据，拿到数据交给 HttpHandler 进行请求处理</span></span><br><span class="line">        ReactorHttpHandlerAdapter adapter = <span class="keyword">new</span> ReactorHttpHandlerAdapter(handler);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//3、启动Netty服务器</span></span><br><span class="line">        HttpServer.create()</span><br><span class="line">                .host(<span class="string">&quot;localhost&quot;</span>)</span><br><span class="line">                .port(<span class="number">8080</span>)</span><br><span class="line">                .handle(adapter) <span class="comment">//用指定的处理器处理请求</span></span><br><span class="line">                .bindNow(); <span class="comment">//现在就绑定</span></span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;服务器启动完成....监听8080，接受请求&quot;</span>);</span><br><span class="line">        System.in.read();</span><br><span class="line">        System.out.println(<span class="string">&quot;服务器停止....&quot;</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="DispatcherHandler"><a href="#DispatcherHandler" class="headerlink" title="DispatcherHandler"></a>DispatcherHandler</h3><blockquote>
<p>SpringMVC： DispatcherServlet；<br>SpringWebFlux： DispatcherHandler</p>
</blockquote>
<h4 id="请求处理流程"><a href="#请求处理流程" class="headerlink" title="请求处理流程"></a>请求处理流程</h4><ul>
<li>HandlerMapping：<strong>请求映射处理器</strong>； 保存每个请求由哪个方法进行处理</li>
<li>HandlerAdapter：<strong>处理器适配器</strong>；反射执行目标方法</li>
<li>HandlerResultHandler：<strong>处理器结果</strong>处理器；</li>
</ul>
<p>SpringMVC： DispatcherServlet 有一个 doDispatch() 方法，来处理所有请求；<br>WebFlux： DispatcherHandler 有一个 handle() 方法，来处理所有请求；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">handle</span><span class="params">(ServerWebExchange exchange)</span> </span>&#123; </span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.handlerMappings == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> createNotFoundError();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (CorsUtils.isPreFlightRequest(exchange.getRequest())) &#123;</span><br><span class="line">			<span class="keyword">return</span> handlePreFlight(exchange);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> Flux.fromIterable(<span class="keyword">this</span>.handlerMappings) <span class="comment">//拿到所有的 handlerMappings</span></span><br><span class="line">				.concatMap(mapping -&gt; mapping.getHandler(exchange)) <span class="comment">//找每一个mapping看谁能处理请求</span></span><br><span class="line">				.next() <span class="comment">//直接触发获取元素； 拿到流的第一个元素； 找到第一个能处理这个请求的handlerAdapter</span></span><br><span class="line">				.switchIfEmpty(createNotFoundError()) <span class="comment">//如果没拿到这个元素，则响应404错误；</span></span><br><span class="line">				.onErrorResume(ex -&gt; handleDispatchError(exchange, ex)) <span class="comment">//异常处理，一旦前面发生异常，调用处理异常</span></span><br><span class="line">				.flatMap(handler -&gt; handleRequestWith(exchange, handler)); <span class="comment">//调用方法处理请求，得到响应结果</span></span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>1、请求和响应都封装在 ServerWebExchange 对象中，由handle方法进行处理</li>
<li>2、如果没有任何的请求映射器； 直接返回一个： 创建一个未找到的错误； 404； 返回Mono.error；终结流</li>
<li>3、跨域工具，是否跨域请求，跨域请求检查是否复杂跨域，需要预检请求；</li>
<li>4、Flux流式操作，先找到HandlerMapping，再获取handlerAdapter，再用Adapter处理请求，期间的错误由onErrorResume触发回调进行处理；</li>
</ul>
<p>源码中的核心两个：</p>
<ul>
<li><strong>handleRequestWith</strong>： 编写了handlerAdapter怎么处理请求</li>
<li><strong>handleResult</strong>： String、User、ServerSendEvent、Mono、Flux …</li>
</ul>
<p>concatMap： 先挨个元素变，然后把变的结果按照之前元素的顺序拼接成一个完整流</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> &lt;R&gt; <span class="function">Mono&lt;R&gt; <span class="title">createNotFoundError</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		Exception ex = <span class="keyword">new</span> ResponseStatusException(HttpStatus.NOT_FOUND);</span><br><span class="line">		<span class="keyword">return</span> Mono.error(ex);</span><br><span class="line">	&#125;</span><br><span class="line">Mono.defer(() -&gt; &#123;</span><br><span class="line">			Exception ex = <span class="keyword">new</span> ResponseStatusException(HttpStatus.NOT_FOUND);</span><br><span class="line">			<span class="keyword">return</span> Mono.error(ex);</span><br><span class="line">		&#125;); <span class="comment">//有订阅者，且流被激活后就动态调用这个方法； 延迟加载；</span></span><br></pre></td></tr></table></figure>

<h3 id="注解开发"><a href="#注解开发" class="headerlink" title="注解开发"></a>注解开发</h3><h4 id="目标方法传参"><a href="#目标方法传参" class="headerlink" title="目标方法传参"></a>目标方法传参</h4><p><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/reference/6.0/web/webflux/controller/ann-methods/arguments.html">Method Arguments :: Spring Framework</a></p>
<table>
<thead>
<tr>
<th>Controller method argument</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td><font color="#953734">ServerWebExchange</font></td>
<td>封装了请求和响应对象的对象; 自定义获取数据、自定义响应</td>
</tr>
<tr>
<td><font color="#953734">ServerHttpRequest, ServerHttpResponse</font></td>
<td>请求、响应</td>
</tr>
<tr>
<td><font color="#953734">WebSession</font></td>
<td>访问Session对象</td>
</tr>
<tr>
<td>java.security.Principal</td>
<td></td>
</tr>
<tr>
<td>org.springframework.http.HttpMethod</td>
<td>请求方式</td>
</tr>
<tr>
<td>java.util.Locale</td>
<td>国际化</td>
</tr>
<tr>
<td>java.util.TimeZone + java.time.ZoneId</td>
<td>时区</td>
</tr>
<tr>
<td>@PathVariable</td>
<td>路径变量</td>
</tr>
<tr>
<td>@MatrixVariable</td>
<td>矩阵变量</td>
</tr>
<tr>
<td>@RequestParam</td>
<td>请求参数</td>
</tr>
<tr>
<td>@RequestHeader</td>
<td>请求头；</td>
</tr>
<tr>
<td>@CookieValue</td>
<td>获取Cookie</td>
</tr>
<tr>
<td>@RequestBody</td>
<td>获取请求体，Post、文件上传</td>
</tr>
<tr>
<td>HttpEntity<B></B></td>
<td>封装后的请求对象</td>
</tr>
<tr>
<td>@RequestPart</td>
<td>获取文件上传的数据 multipart/form-data.</td>
</tr>
<tr>
<td>java.util.Map, org.springframework.ui.Model, and org.springframework.ui.ModelMap.</td>
<td>Map、Model、ModelMap</td>
</tr>
<tr>
<td>@ModelAttribute</td>
<td></td>
</tr>
<tr>
<td>Errors, BindingResult</td>
<td>数据校验，封装错误</td>
</tr>
<tr>
<td>SessionStatus + class-level @SessionAttributes</td>
<td></td>
</tr>
<tr>
<td>UriComponentsBuilder</td>
<td>For preparing a URL relative to the current request’s host, port, scheme, and context path. See <a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/reference/6.0/web/webflux/uri-building.html">URI Links</a>.</td>
</tr>
<tr>
<td>@SessionAttribute</td>
<td></td>
</tr>
<tr>
<td>@RequestAttribute</td>
<td>转发请求的请求域数据</td>
</tr>
<tr>
<td>Any other argument</td>
<td>所有对象都能作为参数：<br><br>1、基本类型 ，等于标注@RequestParam<br><br>2、对象类型，等于标注 @ModelAttribute</td>
</tr>
</tbody></table>
<h4 id="返回值写法"><a href="#返回值写法" class="headerlink" title="返回值写法"></a>返回值写法</h4><p>sse和websocket区别：</p>
<ul>
<li>SSE：单工；请求过去以后，等待服务端源源不断的数据</li>
<li>websocket：双工： 连接建立后，可以任何交互；</li>
</ul>
<table>
<thead>
<tr>
<th>Controller method return value</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>@ResponseBody</td>
<td>把响应数据写出去，如果是对象，可以自动转为json</td>
</tr>
<tr>
<td>HttpEntity<B>, ResponseEntity<B></B></B></td>
<td>ResponseEntity：支持快捷自定义响应内容</td>
</tr>
<tr>
<td>HttpHeaders</td>
<td>没有响应内容，只有响应头</td>
</tr>
<tr>
<td>ErrorResponse</td>
<td>快速构建错误响应</td>
</tr>
<tr>
<td>ProblemDetail</td>
<td>SpringBoot3；</td>
</tr>
<tr>
<td>String</td>
<td>就是和以前的使用规则一样；<br><br>forward: 转发到一个地址<br><br>redirect: 重定向到一个地址<br><br>配合模板引擎</td>
</tr>
<tr>
<td>View</td>
<td>直接返回视图对象</td>
</tr>
<tr>
<td>java.util.Map, org.springframework.ui.Model</td>
<td>以前一样</td>
</tr>
<tr>
<td>@ModelAttribute</td>
<td>以前一样</td>
</tr>
<tr>
<td><font color="#953734">Rendering</font></td>
<td>新版的页面跳转API； 不能标注 @ResponseBody 注解</td>
</tr>
<tr>
<td>void</td>
<td>仅代表响应完成信号</td>
</tr>
<tr>
<td>Flux<ServerSentEvent>, Observable<ServerSentEvent>, or other reactive type</ServerSentEvent></ServerSentEvent></td>
<td>使用 text/event-stream 完成SSE效果</td>
</tr>
<tr>
<td>Other return values</td>
<td>未在上述列表的其他返回值，都会当成给页面的数据；</td>
</tr>
</tbody></table>
<h3 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h3><p><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/reference/6.0/web/webflux/controller/ann-methods/multipart-forms.html">Multipart Content :: Spring Framework</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyForm</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String name;</span><br><span class="line">	<span class="keyword">private</span> MultipartFile file;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FileUploadController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@PostMapping(&quot;/form&quot;)</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">handleFormUpload</span><span class="params">(MyForm form, BindingResult errors)</span> </span>&#123;</span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">handle</span><span class="params">(<span class="meta">@RequestPart(&quot;meta-data&quot;)</span> Part metadata, </span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="meta">@RequestPart(&quot;file-data&quot;)</span> FilePart file)</span> </span>&#123; </span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="错误处理-1"><a href="#错误处理-1" class="headerlink" title="错误处理"></a>错误处理</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">    <span class="meta">@ExceptionHandler(ArithmeticException.class)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">error</span><span class="params">(ArithmeticException exception)</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;发生了数学运算异常&quot;</span>+exception);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//返回这些进行错误处理；</span></span><br><span class="line"><span class="comment">//        ProblemDetail：  建造者：声明式编程、链式调用</span></span><br><span class="line"><span class="comment">//        ErrorResponse ： </span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;炸了，哈哈...&quot;</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="RequestContext"><a href="#RequestContext" class="headerlink" title="RequestContext"></a>RequestContext</h3><h3 id="自定义Flux配置"><a href="#自定义Flux配置" class="headerlink" title="自定义Flux配置"></a>自定义Flux配置</h3><h4 id="WebFluxConfigurer"><a href="#WebFluxConfigurer" class="headerlink" title="WebFluxConfigurer"></a>WebFluxConfigurer</h4><blockquote>
<p>容器中注入这个类型的组件，重写底层逻辑</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyWebConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//配置底层</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> WebFluxConfigurer <span class="title">webFluxConfigurer</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> WebFluxConfigurer() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addCorsMappings</span><span class="params">(CorsRegistry registry)</span> </span>&#123;</span><br><span class="line">                registry.addMapping(<span class="string">&quot;/**&quot;</span>)</span><br><span class="line">                        .allowedHeaders(<span class="string">&quot;*&quot;</span>)</span><br><span class="line">                        .allowedMethods(<span class="string">&quot;*&quot;</span>)</span><br><span class="line">                        .allowedOrigins(<span class="string">&quot;localhost&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Filter"><a href="#Filter" class="headerlink" title="Filter"></a>Filter</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyWebFilter</span> <span class="keyword">implements</span> <span class="title">WebFilter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">filter</span><span class="params">(ServerWebExchange exchange, WebFilterChain chain)</span> </span>&#123;</span><br><span class="line">        ServerHttpRequest request = exchange.getRequest();</span><br><span class="line">        ServerHttpResponse response = exchange.getResponse();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;请求处理放行到目标方法之前...&quot;</span>);</span><br><span class="line">        Mono&lt;Void&gt; filter = chain.filter(exchange); <span class="comment">//放行</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//流一旦经过某个操作就会变成新流</span></span><br><span class="line"></span><br><span class="line">        Mono&lt;Void&gt; voidMono = filter.doOnError(err -&gt; &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;目标方法异常以后...&quot;</span>);</span><br><span class="line">                &#125;) <span class="comment">// 目标方法发生异常后做事</span></span><br><span class="line">                .doFinally(signalType -&gt; &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;目标方法执行以后...&quot;</span>);</span><br><span class="line">                &#125;);<span class="comment">// 目标方法执行之后</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//上面执行不花时间。</span></span><br><span class="line">        <span class="keyword">return</span> voidMono; <span class="comment">//看清楚返回的是谁！！！</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="R2DBC"><a href="#R2DBC" class="headerlink" title="R2DBC"></a>R2DBC</h1><p>Web、网络、IO（存储）、中间件（Redis、MySQL）<br>应用开发：</p>
<ul>
<li>网络</li>
<li><strong>存储</strong>：MySQL、Redis</li>
<li><strong>Web</strong>：Webflux</li>
<li>前端； 后端：Controller – Service – Dao（r2dbc；mysql）</li>
</ul>
<p>数据库：</p>
<ul>
<li><strong>导入驱动</strong>； 以前：JDBC（jdbc、各大驱动mysql-connector）； 现在：r2dbc（<a target="_blank" rel="noopener" href="https://github.com/r2dbc/r2dbc-spi">r2dbc-spi</a>、各大驱动 r2dbc-mysql）</li>
<li><strong>驱动</strong>：</li>
<li>获取连接</li>
<li>发送SQL、执行</li>
<li>封装数据库返回结果</li>
</ul>
<h2 id="R2dbc"><a href="#R2dbc" class="headerlink" title="R2dbc"></a>R2dbc</h2><blockquote>
<p>用法：<br>1、导入驱动: 导入连接池（<a target="_blank" rel="noopener" href="https://github.com/r2dbc/r2dbc-pool">r2dbc-pool</a>）、导入驱动（<a target="_blank" rel="noopener" href="https://github.com/asyncer-io/r2dbc-mysql">r2dbc-mysql</a> ）<br>2、使用驱动提供的API操作</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.asyncer<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>r2dbc-mysql<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//0、MySQL配置</span></span><br><span class="line">MySqlConnectionConfiguration configuration = MySqlConnectionConfiguration.builder()</span><br><span class="line">        .host(<span class="string">&quot;localhost&quot;</span>)</span><br><span class="line">        .port(<span class="number">3306</span>)</span><br><span class="line">        .username(<span class="string">&quot;root&quot;</span>)</span><br><span class="line">        .password(<span class="string">&quot;123456&quot;</span>)</span><br><span class="line">        .database(<span class="string">&quot;test&quot;</span>)</span><br><span class="line">        .build();</span><br><span class="line"></span><br><span class="line"><span class="comment">//1、获取连接工厂</span></span><br><span class="line">MySqlConnectionFactory connectionFactory = MySqlConnectionFactory.from(configuration);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//2、获取到连接，发送sql</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// JDBC： Statement： 封装sql的</span></span><br><span class="line"><span class="comment">//3、数据发布者</span></span><br><span class="line">Mono.from(connectionFactory.create())</span><br><span class="line">        .flatMapMany(connection -&gt;</span><br><span class="line">                connection</span><br><span class="line">                        .createStatement(<span class="string">&quot;select * from t_author where id=?id and name=?name&quot;</span>)</span><br><span class="line">                        .bind(<span class="string">&quot;id&quot;</span>,<span class="number">1L</span>) <span class="comment">//具名参数</span></span><br><span class="line">                        .bind(<span class="string">&quot;name&quot;</span>,<span class="string">&quot;张三&quot;</span>)</span><br><span class="line">                        .execute()</span><br><span class="line">        ).flatMap(result -&gt; &#123;</span><br><span class="line">            <span class="keyword">return</span> result.map(readable -&gt; &#123;</span><br><span class="line">                Long id = readable.get(<span class="string">&quot;id&quot;</span>, Long.class);</span><br><span class="line">                String name = readable.get(<span class="string">&quot;name&quot;</span>, String.class);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> TAuthor(id, name);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;)</span><br><span class="line">        .subscribe(tAuthor -&gt; System.out.println(<span class="string">&quot;tAuthor = &quot;</span> + tAuthor))</span><br><span class="line">;</span><br></pre></td></tr></table></figure>

<h2 id="Spring-Data-R2DBC"><a href="#Spring-Data-R2DBC" class="headerlink" title="Spring Data R2DBC"></a>Spring Data R2DBC</h2><blockquote>
<p>提升生产力方式的 响应式数据库操作</p>
</blockquote>
<h3 id="整合"><a href="#整合" class="headerlink" title="整合"></a>整合</h3><p>1、导入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/io.asyncer/r2dbc-mysql --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.asyncer<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>r2dbc-mysql<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        响应式 Spring Data R2dbc--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-r2dbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>2、编写配置</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">r2dbc:</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">r2dbc:mysql://localhost:3306/test</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">test</span></span><br></pre></td></tr></table></figure>

<h3 id="声明式接口：R2dbcRepository"><a href="#声明式接口：R2dbcRepository" class="headerlink" title="声明式接口：R2dbcRepository"></a>声明式接口：R2dbcRepository</h3><h4 id="Repository接口"><a href="#Repository接口" class="headerlink" title="Repository接口"></a>Repository接口</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AuthorRepositories</span> <span class="keyword">extends</span> <span class="title">R2dbcRepository</span>&lt;<span class="title">TAuthor</span>,<span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//默认继承了一堆CRUD方法； 像mybatis-plus</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//QBC： Query By Criteria</span></span><br><span class="line">    <span class="comment">//QBE： Query By Example</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//成为一个起名工程师  where id In () and name like ?</span></span><br><span class="line">    <span class="comment">//仅限单表复杂条件查询</span></span><br><span class="line">    <span class="function">Flux&lt;TAuthor&gt; <span class="title">findAllByIdInAndNameLike</span><span class="params">(Collection&lt;Long&gt; id, String name)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//多表复杂查询</span></span><br><span class="line">    <span class="meta">@Query(&quot;select * from t_author&quot;)</span> <span class="comment">//自定义query注解，指定sql语句</span></span><br><span class="line">    <span class="function">Flux&lt;TAuthor&gt; <span class="title">findHaha</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1-1：关联</span></span><br><span class="line">    <span class="comment">// 1-N：关联</span></span><br><span class="line">    <span class="comment">//场景：</span></span><br><span class="line">    <span class="comment">// 1、一个图书有唯一作者； 1-1</span></span><br><span class="line">    <span class="comment">// 2、一个作者可以有很多图书： 1-N</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="自定义Converter"><a href="#自定义Converter" class="headerlink" title="自定义Converter"></a>自定义Converter</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.r2dbc.config.converter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.atguigu.r2dbc.entity.TAuthor;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.r2dbc.entity.TBook;</span><br><span class="line"><span class="keyword">import</span> io.r2dbc.spi.Row;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.convert.converter.Converter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.convert.ReadingConverter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.Instant;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lfy</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2023-12-23 22:04</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 告诉Spring Data 怎么封装Book对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@ReadingConverter</span> <span class="comment">//读取数据库数据的时候,把row转成 TBook</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BookConverter</span> <span class="keyword">implements</span> <span class="title">Converter</span>&lt;<span class="title">Row</span>, <span class="title">TBook</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> TBook <span class="title">convert</span><span class="params">(Row source)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(source == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">//自定义结果集的封装</span></span><br><span class="line">        TBook tBook = <span class="keyword">new</span> TBook();</span><br><span class="line"></span><br><span class="line">        tBook.setId(source.get(<span class="string">&quot;id&quot;</span>, Long.class));</span><br><span class="line">        tBook.setTitle(source.get(<span class="string">&quot;title&quot;</span>, String.class));</span><br><span class="line"></span><br><span class="line">        Long author_id = source.get(<span class="string">&quot;author_id&quot;</span>, Long.class);</span><br><span class="line">        tBook.setAuthorId(author_id);</span><br><span class="line">        <span class="comment">//        tBook.setPublishTime(source.get(&quot;publish_time&quot;, Instant.class));</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        TAuthor tAuthor = <span class="keyword">new</span> TAuthor();</span><br><span class="line">        tAuthor.setId(author_id);</span><br><span class="line">        tAuthor.setName(source.get(<span class="string">&quot;name&quot;</span>, String.class));</span><br><span class="line"></span><br><span class="line">        tBook.setAuthor(tAuthor);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="配置生效"><a href="#配置生效" class="headerlink" title="配置生效"></a>配置生效</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableR2dbcRepositories</span> <span class="comment">//开启 R2dbc 仓库功能；jpa</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">R2DbcConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span> <span class="comment">//替换容器中原来的</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> R2dbcCustomConversions <span class="title">conversions</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//把我们的转换器加入进去； 效果新增了我们的 Converter</span></span><br><span class="line">        <span class="keyword">return</span> R2dbcCustomConversions.of(MySqlDialect.INSTANCE,<span class="keyword">new</span> BookConverter());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="编程式组件"><a href="#编程式组件" class="headerlink" title="编程式组件"></a>编程式组件</h3><ul>
<li>R2dbcEntityTemplate</li>
<li>DatabaseClient</li>
</ul>
<h2 id="RBAC-SQL练习"><a href="#RBAC-SQL练习" class="headerlink" title="RBAC-SQL练习"></a>RBAC-SQL练习</h2><h3 id="1-1"><a href="#1-1" class="headerlink" title="1-1"></a>1-1</h3><ul>
<li>自定义 Converter&lt;Row，Bean&gt; 方式<figure class="highlight java"><figcaption><span>@Bean</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function">R2dbcCustomConversions <span class="title">r2dbcCustomConversions</span><span class="params">()</span></span>&#123;</span><br><span class="line">        List&lt;Converter&lt;?, ?&gt;&gt; converters = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        converters.add(<span class="keyword">new</span> BookConverter());</span><br><span class="line">        <span class="keyword">return</span> R2dbcCustomConversions.of(MySqlDialect.INSTANCE, converters);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//1-1： 结合自定义 Converter</span></span><br><span class="line">bookRepostory.hahaBook(<span class="number">1L</span>)</span><br><span class="line">        .subscribe(tBook -&gt; System.out.println(<span class="string">&quot;tBook = &quot;</span> + tBook));</span><br></pre></td></tr></table></figure></li>
</ul>
<ul>
<li>编程式封装方式: 使用DatabaseClient<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1-1：第二种方式</span></span><br><span class="line">databaseClient.sql(<span class="string">&quot;select b.*,t.name as name from t_book b &quot;</span> +</span><br><span class="line">                <span class="string">&quot;LEFT JOIN t_author t on b.author_id = t.id &quot;</span> +</span><br><span class="line">                <span class="string">&quot;WHERE b.id = ?&quot;</span>)</span><br><span class="line">        .bind(<span class="number">0</span>, <span class="number">1L</span>)</span><br><span class="line">        .fetch()</span><br><span class="line">        .all()</span><br><span class="line">        .map(row-&gt; &#123;</span><br><span class="line">            String id = row.get(<span class="string">&quot;id&quot;</span>).toString();</span><br><span class="line">            String title = row.get(<span class="string">&quot;title&quot;</span>).toString();</span><br><span class="line">            String author_id = row.get(<span class="string">&quot;author_id&quot;</span>).toString();</span><br><span class="line">            String name = row.get(<span class="string">&quot;name&quot;</span>).toString();</span><br><span class="line">            TBook tBook = <span class="keyword">new</span> TBook();</span><br><span class="line"></span><br><span class="line">            tBook.setId(Long.parseLong(id));</span><br><span class="line">            tBook.setTitle(title);</span><br><span class="line"></span><br><span class="line">            TAuthor tAuthor = <span class="keyword">new</span> TAuthor();</span><br><span class="line">            tAuthor.setName(name);</span><br><span class="line">            tAuthor.setId(Long.parseLong(author_id));</span><br><span class="line"></span><br><span class="line">            tBook.setAuthor(tAuthor);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> tBook;</span><br><span class="line">        &#125;)</span><br><span class="line">        .subscribe(tBook -&gt; System.out.println(<span class="string">&quot;tBook = &quot;</span> + tBook));</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="1-N"><a href="#1-N" class="headerlink" title="1-N"></a>1-N</h3><ul>
<li>使用底层API DatabaseClient；<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">oneToN</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//        databaseClient.sql(&quot;select a.id aid,a.name,b.* from t_author a  &quot; +</span></span><br><span class="line"><span class="comment">//                &quot;left join t_book b on a.id = b.author_id &quot; +</span></span><br><span class="line"><span class="comment">//                &quot;order by a.id&quot;)</span></span><br><span class="line"><span class="comment">//                .fetch()</span></span><br><span class="line"><span class="comment">//                .all(row -&gt; &#123;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//                &#125;)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1~6</span></span><br><span class="line">        <span class="comment">// 1：false 2：false 3:false 4: true 8:true 5:false 6:false 7:false 8:true 9:false 10:false</span></span><br><span class="line">        <span class="comment">// [1,2,3]</span></span><br><span class="line">        <span class="comment">// [4,8]</span></span><br><span class="line">        <span class="comment">// [5,6,7]</span></span><br><span class="line">        <span class="comment">// [8]</span></span><br><span class="line">        <span class="comment">// [9,10]</span></span><br><span class="line">        <span class="comment">// bufferUntilChanged：</span></span><br><span class="line">        <span class="comment">// 如果下一个判定值比起上一个发生了变化就开一个新buffer保存，如果没有变化就保存到原buffer中</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//        Flux.just(1,2,3,4,8,5,6,7,8,9,10)</span></span><br><span class="line"><span class="comment">//                .bufferUntilChanged(integer -&gt; integer%4==0 )</span></span><br><span class="line"><span class="comment">//                .subscribe(list-&gt; System.out.println(&quot;list = &quot; + list));</span></span><br><span class="line">        ; <span class="comment">//自带分组</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Flux&lt;TAuthor&gt; flux = databaseClient.sql(<span class="string">&quot;select a.id aid,a.name,b.* from t_author a  &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;left join t_book b on a.id = b.author_id &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;order by a.id&quot;</span>)</span><br><span class="line">                .fetch()</span><br><span class="line">                .all()</span><br><span class="line">                .bufferUntilChanged(rowMap -&gt; Long.parseLong(rowMap.get(<span class="string">&quot;aid&quot;</span>).toString()))</span><br><span class="line">                .map(list -&gt; &#123;</span><br><span class="line">                    TAuthor tAuthor = <span class="keyword">new</span> TAuthor();</span><br><span class="line">                    Map&lt;String, Object&gt; map = list.get(<span class="number">0</span>);</span><br><span class="line">                    tAuthor.setId(Long.parseLong(map.get(<span class="string">&quot;aid&quot;</span>).toString()));</span><br><span class="line">                    tAuthor.setName(map.get(<span class="string">&quot;name&quot;</span>).toString());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                    <span class="comment">//查到的所有图书</span></span><br><span class="line">                    List&lt;TBook&gt; tBooks = list.stream()</span><br><span class="line">                            .map(ele -&gt; &#123;</span><br><span class="line">                                TBook tBook = <span class="keyword">new</span> TBook();</span><br><span class="line"></span><br><span class="line">                                tBook.setId(Long.parseLong(ele.get(<span class="string">&quot;id&quot;</span>).toString()));</span><br><span class="line">                                tBook.setAuthorId(Long.parseLong(ele.get(<span class="string">&quot;author_id&quot;</span>).toString()));</span><br><span class="line">                                tBook.setTitle(ele.get(<span class="string">&quot;title&quot;</span>).toString());</span><br><span class="line">                                <span class="keyword">return</span> tBook;</span><br><span class="line">                            &#125;)</span><br><span class="line">                            .collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">                    tAuthor.setBooks(tBooks);</span><br><span class="line">                    <span class="keyword">return</span> tAuthor;</span><br><span class="line">                &#125;);<span class="comment">//Long 数字缓存 -127 - 127；// 对象比较需要自己写好equals方法</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        flux.subscribe(tAuthor -&gt; System.out.println(<span class="string">&quot;tAuthor = &quot;</span> + tAuthor));</span><br><span class="line"></span><br><span class="line">        System.in.read();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a>最佳实践</h2><blockquote>
<p>最佳实践： 提升生产效率的做法</p>
<ul>
<li>1、Spring Data R2DBC，基础的CRUD用 <strong>R2dbcRepository</strong> 提供好了</li>
<li>2、自定义复杂的SQL（<strong>单表</strong>）： <strong>@Query</strong>；</li>
<li>3、<strong>多表查询复杂结果集</strong>： <strong>DatabaseClient</strong> 自定义SQL及结果封装；<ul>
<li><strong>@Query + 自定义 Converter 实现结果封装</strong></li>
</ul>
</li>
</ul>
<p><strong>经验：</strong></p>
<ul>
<li><strong>1-1:1-N 关联关系的封装都需要自定义结果集的方式</strong><ul>
<li><strong>Spring Data R2DBC：</strong><ul>
<li><strong>自定义Converter指定结果封装</strong></li>
<li><strong>DatabaseClient：贴近底层的操作进行封装; 见下面代码</strong></li>
</ul>
</li>
<li><strong>MyBatis： 自定义 ResultMap 标签去来封装</strong></li>
</ul>
</li>
</ul>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">databaseClient.sql(<span class="string">&quot;select b.*,t.name as name from t_book b &quot;</span> +</span><br><span class="line">                <span class="string">&quot;LEFT JOIN t_author t on b.author_id = t.id &quot;</span> +</span><br><span class="line">                <span class="string">&quot;WHERE b.id = ?&quot;</span>)</span><br><span class="line">        .bind(<span class="number">0</span>, <span class="number">1L</span>)</span><br><span class="line">        .fetch()</span><br><span class="line">        .all()</span><br><span class="line">        .map(row-&gt; &#123;</span><br><span class="line">            String id = row.get(<span class="string">&quot;id&quot;</span>).toString();</span><br><span class="line">            String title = row.get(<span class="string">&quot;title&quot;</span>).toString();</span><br><span class="line">            String author_id = row.get(<span class="string">&quot;author_id&quot;</span>).toString();</span><br><span class="line">            String name = row.get(<span class="string">&quot;name&quot;</span>).toString();</span><br><span class="line">            TBook tBook = <span class="keyword">new</span> TBook();</span><br><span class="line"></span><br><span class="line">            tBook.setId(Long.parseLong(id));</span><br><span class="line">            tBook.setTitle(title);</span><br><span class="line"></span><br><span class="line">            TAuthor tAuthor = <span class="keyword">new</span> TAuthor();</span><br><span class="line">            tAuthor.setName(name);</span><br><span class="line">            tAuthor.setId(Long.parseLong(author_id));</span><br><span class="line"></span><br><span class="line">            tBook.setAuthor(tAuthor);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> tBook;</span><br><span class="line">        &#125;)</span><br><span class="line">        .subscribe(tBook -&gt; System.out.println(<span class="string">&quot;tBook = &quot;</span> + tBook));</span><br></pre></td></tr></table></figure>

<h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h2><ul>
<li>RBAC SQL文件<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">-- 用户表</span><br><span class="line">DROP TABLE IF EXISTS `t_user`;</span><br><span class="line">CREATE TABLE `t_user`(</span><br><span class="line">                           `id` bigint(<span class="number">20</span>) NOT NULL AUTO_INCREMENT,</span><br><span class="line">                           `username` varchar(<span class="number">255</span>) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci NOT NULL COMMENT <span class="string">&#x27;用户名&#x27;</span>,</span><br><span class="line">                           `password` varchar(<span class="number">255</span>) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci NOT NULL COMMENT <span class="string">&#x27;密码&#x27;</span>,</span><br><span class="line">                           `email` varchar(<span class="number">255</span>) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci NOT NULL COMMENT <span class="string">&#x27;邮箱&#x27;</span>,</span><br><span class="line">                           `phone` <span class="keyword">char</span>(<span class="number">11</span>) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci NOT NULL COMMENT <span class="string">&#x27;电话&#x27;</span>,</span><br><span class="line">                           `create_time` datetime(<span class="number">0</span>) NOT NULL COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">                           `update_time` datetime(<span class="number">0</span>) NOT NULL COMMENT <span class="string">&#x27;更新时间&#x27;</span>,</span><br><span class="line">                           <span class="function">PRIMARY <span class="title">KEY</span> <span class="params">(`id`)</span> USING BTREE</span></span><br><span class="line"><span class="function">) ENGINE </span>= InnoDB  CHARACTER SET = utf8mb4 COLLATE = utf8mb4_0900_ai_ci ROW_FORMAT = Dynamic;</span><br><span class="line"></span><br><span class="line">-- 角色表</span><br><span class="line">DROP TABLE IF EXISTS `t_roles`;</span><br><span class="line">CREATE TABLE `t_roles`(</span><br><span class="line">                            `id` bigint(<span class="number">20</span>) NOT NULL AUTO_INCREMENT,</span><br><span class="line">                            `name` varchar(<span class="number">255</span>) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci NOT NULL COMMENT <span class="string">&#x27;角色名&#x27;</span>,</span><br><span class="line">                            `value` varchar(<span class="number">255</span>) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci NOT NULL COMMENT <span class="string">&#x27;角色的英文名&#x27;</span>,</span><br><span class="line">                            `create_time` datetime(<span class="number">0</span>) NOT NULL,</span><br><span class="line">                            `update_time` datetime(<span class="number">0</span>) NOT NULL,</span><br><span class="line">                            <span class="function">PRIMARY <span class="title">KEY</span> <span class="params">(`id`)</span> USING BTREE</span></span><br><span class="line"><span class="function">) ENGINE </span>= InnoDB  CHARACTER SET = utf8mb4 COLLATE = utf8mb4_0900_ai_ci ROW_FORMAT = Dynamic;</span><br><span class="line"></span><br><span class="line">-- 权限表（资源表）</span><br><span class="line">DROP TABLE IF EXISTS `t_perm`;</span><br><span class="line">CREATE TABLE `t_perm`(</span><br><span class="line">                               `id` bigint(<span class="number">20</span>) NOT NULL AUTO_INCREMENT,</span><br><span class="line">                               `value` varchar(<span class="number">255</span>) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci NOT NULL COMMENT <span class="string">&#x27;权限字段&#x27;</span>,</span><br><span class="line">                               `uri` varchar(<span class="number">255</span>) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci NOT NULL COMMENT <span class="string">&#x27;资源路径&#x27;</span>,</span><br><span class="line">                               `description` varchar(<span class="number">255</span>) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci NOT NULL COMMENT <span class="string">&#x27;资源描述&#x27;</span>,</span><br><span class="line">                               `create_time` datetime(<span class="number">0</span>) NOT NULL,</span><br><span class="line">                               `update_time` datetime(<span class="number">0</span>) NOT NULL,</span><br><span class="line">                               <span class="function">PRIMARY <span class="title">KEY</span> <span class="params">(`id`)</span> USING BTREE</span></span><br><span class="line"><span class="function">) ENGINE </span>= InnoDB  CHARACTER SET = utf8mb4 COLLATE = utf8mb4_0900_ai_ci ROW_FORMAT = Dynamic;</span><br><span class="line"></span><br><span class="line">-- 用户角色关系表</span><br><span class="line">DROP TABLE IF EXISTS `t_user_role`;</span><br><span class="line">CREATE TABLE `t_user_role`(</span><br><span class="line">                                `id` bigint(<span class="number">20</span>) NOT NULL AUTO_INCREMENT,</span><br><span class="line">                                `user_id` bigint(<span class="number">20</span>) NOT NULL,</span><br><span class="line">                                `role_id` bigint(<span class="number">20</span>) NOT NULL,</span><br><span class="line">                                `create_time` datetime(<span class="number">0</span>) NOT NULL,</span><br><span class="line">                                `update_time` datetime(<span class="number">0</span>) NOT NULL,</span><br><span class="line">                                <span class="function">PRIMARY <span class="title">KEY</span> <span class="params">(`id`)</span> USING BTREE</span></span><br><span class="line"><span class="function">) ENGINE </span>= InnoDB  CHARACTER SET = utf8mb4 COLLATE = utf8mb4_0900_ai_ci ROW_FORMAT = Dynamic;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-- 角色权限关系表</span><br><span class="line">DROP TABLE IF EXISTS `t_role_perm`;</span><br><span class="line">CREATE TABLE `t_role_perm`(</span><br><span class="line">                                    `id` bigint(<span class="number">20</span>) NOT NULL AUTO_INCREMENT,</span><br><span class="line">                                    `role_id` bigint(<span class="number">20</span>) NOT NULL,</span><br><span class="line">                                    `perm_id` bigint(<span class="number">20</span>) NOT NULL,</span><br><span class="line">                                    `create_time` datetime(<span class="number">0</span>) NOT NULL,</span><br><span class="line">                                    `update_time` datetime(<span class="number">0</span>) NOT NULL,</span><br><span class="line">                                    <span class="function">PRIMARY <span class="title">KEY</span> <span class="params">(`id`)</span> USING BTREE</span></span><br><span class="line"><span class="function">) ENGINE </span>= InnoDB CHARACTER SET = utf8mb4 COLLATE = utf8mb4_0900_ai_ci ROW_FORMAT = Dynamic;</span><br><span class="line"></span><br><span class="line">-- 图书&amp;作者表</span><br><span class="line">CREATE TABLE `t_book`(</span><br><span class="line">                              `id` bigint(<span class="number">20</span>) NOT NULL AUTO_INCREMENT,</span><br><span class="line">                              `title` varchar(<span class="number">255</span>) NOT NULL,</span><br><span class="line">                              `author_id` bigint(<span class="number">20</span>) NOT NULL,</span><br><span class="line">                              `publish_time` datetime(<span class="number">0</span>) NOT NULL,</span><br><span class="line">                              <span class="function">PRIMARY <span class="title">KEY</span> <span class="params">(`id`)</span> USING BTREE</span></span><br><span class="line"><span class="function">) ENGINE </span>= InnoDB CHARACTER SET = utf8mb4 COLLATE = utf8mb4_0900_ai_ci ROW_FORMAT = Dynamic;</span><br><span class="line"></span><br><span class="line">CREATE TABLE `t_author`(</span><br><span class="line">                         `id` bigint(<span class="number">20</span>) NOT NULL AUTO_INCREMENT,</span><br><span class="line">                         `name` varchar(<span class="number">255</span>) NOT NULL,</span><br><span class="line">                         <span class="function">PRIMARY <span class="title">KEY</span> <span class="params">(`id`)</span> USING BTREE</span></span><br><span class="line"><span class="function">) ENGINE </span>= InnoDB CHARACTER SET = utf8mb4 COLLATE = utf8mb4_0900_ai_ci ROW_FORMAT = Dynamic;</span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="Spring-Security-Reactive"><a href="#Spring-Security-Reactive" class="headerlink" title="Spring Security Reactive"></a>Spring Security Reactive</h1><blockquote>
<p>目标：<br>SpringBoot + Webflux + Spring Data R2DBC + Spring Security</p>
</blockquote>
<h2 id="整合-1"><a href="#整合-1" class="headerlink" title="整合"></a>整合</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- https://mvnrepository.com/artifact/io.asyncer/r2dbc-mysql --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.asyncer<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>r2dbc-mysql<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--        响应式 Spring Data R2dbc--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-r2dbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--        响应式Web  --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-webflux<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="开发"><a href="#开发" class="headerlink" title="开发"></a>开发</h2><h3 id="应用安全"><a href="#应用安全" class="headerlink" title="应用安全"></a>应用安全</h3><ul>
<li><strong>防止攻击</strong>：<ul>
<li>DDos、CSRF、XSS、SQL注入…</li>
</ul>
</li>
<li><strong>控制权限</strong><ul>
<li>登录的用户能干什么。</li>
<li>用户登录系统以后要控制住用户的所有行为，防止越权；</li>
</ul>
</li>
<li>传输加密<ul>
<li>https</li>
<li>X509</li>
</ul>
</li>
<li>认证：<ul>
<li>OAuth2.0</li>
<li>JWT</li>
</ul>
</li>
</ul>
<h3 id="RBAC权限模型"><a href="#RBAC权限模型" class="headerlink" title="RBAC权限模型"></a>RBAC权限模型</h3><p>Role Based Access Controll： 基于角色的访问控制</p>
<p>一个网站有很多<strong>用户</strong>： zhangsan<br>每个用户可以有很多<strong>角色</strong>：<br>一个角色可以关联很多<strong>权限</strong>：</p>
<p>一个人到底能干什么？</p>
<blockquote>
<p>权限控制：</p>
<ul>
<li>找到这个人，看他有哪些角色，每个角色能拥有哪些<strong>权限</strong>。 这个人就拥有一堆的 <strong>角色</strong> 或者 <strong>权限</strong></li>
<li>这个人执行方法的时候，我们给方法规定好权限，由权限框架负责判断，这个人是否有指定的权限</li>
</ul>
</blockquote>
<p>所有权限框架：</p>
<ul>
<li>让用户登录进来： <strong>认证（authenticate）</strong>：用账号密码、各种其他方式，先让用户进来</li>
<li>查询用户拥有的所有角色和权限： <strong>授权（authorize）</strong>： 每个方法执行的时候，匹配角色或者权限来判定用户是否可以执行这个方法</li>
</ul>
<h2 id="认证"><a href="#认证" class="headerlink" title="认证"></a>认证</h2><blockquote>
<p>登录行为</p>
</blockquote>
<h3 id="静态资源放行"><a href="#静态资源放行" class="headerlink" title="静态资源放行"></a>静态资源放行</h3><h3 id="其他请求需要登录"><a href="#其他请求需要登录" class="headerlink" title="其他请求需要登录"></a>其他请求需要登录</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.security.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.atguigu.security.component.AppReactiveUserDetailsService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.security.reactive.PathRequest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Primary;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.UserDetailsRepositoryReactiveAuthenticationManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.method.configuration.EnableReactiveMethodSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.web.server.ServerHttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.ReactiveUserDetailsService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.factory.PasswordEncoderFactories;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.password.PasswordEncoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.SecurityFilterChain;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.server.SecurityWebFilterChain;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lfy</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2023-12-24 21:39</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableReactiveMethodSecurity</span> <span class="comment">//开启响应式 的 基于方法级别的权限控制</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppSecurityConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    ReactiveUserDetailsService appReactiveUserDetailsService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function">SecurityWebFilterChain <span class="title">springSecurityFilterChain</span><span class="params">(ServerHttpSecurity http)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//1、定义哪些请求需要认证，哪些不需要</span></span><br><span class="line">        http.authorizeExchange(authorize -&gt; &#123;</span><br><span class="line">            <span class="comment">//1.1、允许所有人都访问静态资源；</span></span><br><span class="line">            authorize.matchers(PathRequest.toStaticResources()</span><br><span class="line">                    .atCommonLocations()).permitAll();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment">//1.2、剩下的所有请求都需要认证（登录）</span></span><br><span class="line">            authorize.anyExchange().authenticated();</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2、开启默认的表单登录</span></span><br><span class="line">        http.formLogin(formLoginSpec -&gt; &#123;</span><br><span class="line"><span class="comment">//            formLoginSpec.loginPage(&quot;/haha&quot;);</span></span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3、安全控制:</span></span><br><span class="line">        http.csrf(csrfSpec -&gt; &#123;</span><br><span class="line">            csrfSpec.disable();</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 目前认证： 用户名 是 user  密码是默认生成。</span></span><br><span class="line">        <span class="comment">// 期望认证： 去数据库查用户名和密码</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//4、配置 认证规则： 如何去数据库中查询到用户;</span></span><br><span class="line">        <span class="comment">// Sprinbg Security 底层使用 ReactiveAuthenticationManager 去查询用户信息</span></span><br><span class="line">        <span class="comment">// ReactiveAuthenticationManager 有一个实现是</span></span><br><span class="line">        <span class="comment">//   UserDetailsRepositoryReactiveAuthenticationManager： 用户信息去数据库中查</span></span><br><span class="line">        <span class="comment">//   UDRespAM 需要  ReactiveUserDetailsService：</span></span><br><span class="line">        <span class="comment">// 我们只需要自己写一个 ReactiveUserDetailsService： 响应式的用户详情查询服务</span></span><br><span class="line">        http.authenticationManager(</span><br><span class="line">                <span class="keyword">new</span> UserDetailsRepositoryReactiveAuthenticationManager(</span><br><span class="line">                        appReactiveUserDetailsService)</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//        http.addFilterAt()</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//构建出安全配置</span></span><br><span class="line">        <span class="keyword">return</span> http.build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function">PasswordEncoder <span class="title">passwordEncoder</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        PasswordEncoder encoder = PasswordEncoderFactories.createDelegatingPasswordEncoder();</span><br><span class="line">        <span class="keyword">return</span> encoder;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2024/01/14/spring/%E5%B0%9A%E7%A1%85%E8%B0%B7springboot3%E5%93%8D%E5%BA%94%E5%BC%8F%E7%BC%96%E7%A8%8B/SpringSecurity%E9%BB%98%E8%AE%A4%E7%99%BB%E5%BD%95%E9%A1%B5%E9%9D%A2%E5%9B%BE%E7%A4%BA.png" alt="SpringSecurity默认登录页面图示"></p>
<p>这个界面点击登录，最终Spring Security 框架会使用 ReactiveUserDetailsService 组件，按照 表单提交的用户名 去<strong>数据库查询</strong>这个<strong>用户详情</strong>（<strong>基本信息</strong> [账号、密码]，<strong>角色</strong>，<strong>权限</strong>）；</p>
<p>把数据库中返回的 <strong>用户详情</strong> 中的密码 和 表单提交的密码进行比对。比对成功则登录成功</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.security.component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.r2dbc.core.DatabaseClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.authority.SimpleGrantedAuthority;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.ReactiveUserDetailsService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.User;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetails;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.factory.PasswordEncoderFactories;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.password.PasswordEncoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Mono;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lfy</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2023-12-24 21:57</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span>  <span class="comment">// 来定义如何去数据库中按照用户名查用户</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppReactiveUserDetailsService</span> <span class="keyword">implements</span> <span class="title">ReactiveUserDetailsService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    DatabaseClient databaseClient;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 自定义如何按照用户名去数据库查询用户信息</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    PasswordEncoder passwordEncoder;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;UserDetails&gt; <span class="title">findByUsername</span><span class="params">(String username)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//        PasswordEncoder encoder = PasswordEncoderFactories.createDelegatingPasswordEncoder();</span></span><br><span class="line">        <span class="comment">//从数据库查询用户、角色、权限所有数据的逻辑</span></span><br><span class="line">        Mono&lt;UserDetails&gt; userDetailsMono = databaseClient.sql(<span class="string">&quot;select u.*,r.id rid,r.name,r.value,pm.id pid,pm.value pvalue,pm.description &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;from t_user u &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;left join t_user_role ur on ur.user_id=u.id &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;left join t_roles r on r.id = ur.role_id &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;left join t_role_perm rp on rp.role_id=r.id &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;left join t_perm pm on rp.perm_id=pm.id &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;where u.username = ? limit 1&quot;</span>)</span><br><span class="line">                .bind(<span class="number">0</span>, username)</span><br><span class="line">                .fetch()</span><br><span class="line">                .one()<span class="comment">// all()</span></span><br><span class="line">                .map(map -&gt; &#123;</span><br><span class="line">                    UserDetails details = User.builder()</span><br><span class="line">                            .username(username)</span><br><span class="line">                            .password(map.get(<span class="string">&quot;password&quot;</span>).toString())</span><br><span class="line">                            <span class="comment">//自动调用密码加密器把前端传来的明文 encode</span></span><br><span class="line"><span class="comment">//                            .passwordEncoder(str-&gt; passwordEncoder.encode(str)) //为啥？？？</span></span><br><span class="line">                            <span class="comment">//权限</span></span><br><span class="line"><span class="comment">//                            .authorities(new SimpleGrantedAuthority(&quot;ROLE_delete&quot;)) //默认不成功</span></span><br><span class="line">                            .roles(<span class="string">&quot;admin&quot;</span>, <span class="string">&quot;sale&quot;</span>,<span class="string">&quot;haha&quot;</span>,<span class="string">&quot;delete&quot;</span>) <span class="comment">//ROLE成功</span></span><br><span class="line">                            .build();</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//角色和权限都被封装成 SimpleGrantedAuthority</span></span><br><span class="line">                    <span class="comment">// 角色有 ROLE_ 前缀， 权限没有</span></span><br><span class="line">                    <span class="comment">// hasRole：hasAuthority</span></span><br><span class="line">                    <span class="keyword">return</span> details;</span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> userDetailsMono;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="授权"><a href="#授权" class="headerlink" title="授权"></a>授权</h2><p>@EnableReactiveMethodSecurity</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.security.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.security.access.prepost.PreAuthorize;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Mono;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lfy</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2023-12-24 21:31</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@PreAuthorize(&quot;hasRole(&#x27;admin&#x27;)&quot;)</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/hello&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;String&gt; <span class="title">hello</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Mono.just(<span class="string">&quot;hello world!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 角色 haha： ROLE_haha：角色</span></span><br><span class="line">    <span class="comment">// 没有ROLE 前缀是权限</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//复杂的SpEL表达式</span></span><br><span class="line">    <span class="meta">@PreAuthorize(&quot;hasRole(&#x27;delete&#x27;)&quot;)</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/world&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;String&gt; <span class="title">world</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Mono.just(<span class="string">&quot;world!!!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>官方示例：<a target="_blank" rel="noopener" href="https://github.com/spring-projects/spring-security-samples/tree/main">GitHub - spring-projects/spring-security-samples</a></p>
<p>配置是： SecurityWebFilterChain</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.security.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.atguigu.security.component.AppReactiveUserDetailsService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.security.reactive.PathRequest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Primary;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.UserDetailsRepositoryReactiveAuthenticationManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.method.configuration.EnableReactiveMethodSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.web.server.ServerHttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.ReactiveUserDetailsService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.factory.PasswordEncoderFactories;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.password.PasswordEncoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.SecurityFilterChain;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.server.SecurityWebFilterChain;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lfy</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2023-12-24 21:39</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableReactiveMethodSecurity</span> <span class="comment">//开启响应式 的 基于方法级别的权限控制</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppSecurityConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    ReactiveUserDetailsService appReactiveUserDetailsService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function">SecurityWebFilterChain <span class="title">springSecurityFilterChain</span><span class="params">(ServerHttpSecurity http)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//1、定义哪些请求需要认证，哪些不需要</span></span><br><span class="line">        http.authorizeExchange(authorize -&gt; &#123;</span><br><span class="line">            <span class="comment">//1.1、允许所有人都访问静态资源；</span></span><br><span class="line">            authorize.matchers(PathRequest.toStaticResources()</span><br><span class="line">                    .atCommonLocations()).permitAll();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment">//1.2、剩下的所有请求都需要认证（登录）</span></span><br><span class="line">            authorize.anyExchange().authenticated();</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2、开启默认的表单登录</span></span><br><span class="line">        http.formLogin(formLoginSpec -&gt; &#123;</span><br><span class="line"><span class="comment">//            formLoginSpec.loginPage(&quot;/haha&quot;);</span></span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3、安全控制:</span></span><br><span class="line">        http.csrf(csrfSpec -&gt; &#123;</span><br><span class="line">            csrfSpec.disable();</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 目前认证： 用户名 是 user  密码是默认生成。</span></span><br><span class="line">        <span class="comment">// 期望认证： 去数据库查用户名和密码</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//4、配置 认证规则： 如何去数据库中查询到用户;</span></span><br><span class="line">        <span class="comment">// Sprinbg Security 底层使用 ReactiveAuthenticationManager 去查询用户信息</span></span><br><span class="line">        <span class="comment">// ReactiveAuthenticationManager 有一个实现是</span></span><br><span class="line">        <span class="comment">//   UserDetailsRepositoryReactiveAuthenticationManager： 用户信息去数据库中查</span></span><br><span class="line">        <span class="comment">//   UDRespAM 需要  ReactiveUserDetailsService：</span></span><br><span class="line">        <span class="comment">// 我们只需要自己写一个 ReactiveUserDetailsService： 响应式的用户详情查询服务</span></span><br><span class="line">        http.authenticationManager(</span><br><span class="line">                <span class="keyword">new</span> UserDetailsRepositoryReactiveAuthenticationManager(</span><br><span class="line">                        appReactiveUserDetailsService)</span><br><span class="line">        );</span><br><span class="line">        <span class="comment">//构建出安全配置</span></span><br><span class="line">        <span class="keyword">return</span> http.build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function">PasswordEncoder <span class="title">passwordEncoder</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        PasswordEncoder encoder = PasswordEncoderFactories.createDelegatingPasswordEncoder();</span><br><span class="line">        <span class="keyword">return</span> encoder;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/springboot3/" rel="tag"># springboot3</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2023/12/19/spring/%E5%B0%9A%E7%A1%85%E8%B0%B7springboot3%E5%9C%BA%E6%99%AF%E6%95%B4%E5%90%88/" rel="prev" title="尚硅谷springboot3场景整合">
                  <i class="fa fa-angle-left"></i> 尚硅谷springboot3场景整合
                </a>
            </div>
            <div class="post-nav-item">
            </div>
          </div>
<hr>
<div id="comment-container"></div>
<script src='//unpkg.com/valine/dist/Valine.min.js'></script>
<script>
    new Valine({
        el: '#comment-container',
        appId: 'SsNHix8sOQXkmksOkIvo0jkf-gzGzoHsz',
        appKey: 'BCtPpmnU41TOE7Wr5O0CJFgS'
    })
</script>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">YS</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">787k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">23:52</span>
  </span>
</div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.2/anime.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.28/fancybox/fancybox.umd.js" integrity="sha256-ytMJGN3toR+a84u7g7NuHm91VIR06Q41kMWDr2pq7Zo=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js"></script>
<script src="/js/third-party/search/local-search.js"></script>




  <script src="/js/third-party/fancybox.js"></script>



  





</body>
</html>
